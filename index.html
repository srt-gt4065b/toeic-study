<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸš€ í† ìµ ì˜ë‹¨ì–´ ê°¤ëŸ¬ê·¸</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            touch-action: none;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a15 0%, #1a1a2e 50%, #0a0a15 100%);
            color: white;
        }

        /* ===== ê³µí†µ ìŠ¤íƒ€ì¼ ===== */
        .screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow-y: auto;
        }

        .screen.active {
            display: flex;
        }

        .card {
            background: rgba(26, 26, 46, 0.95);
            border: 2px solid #667eea;
            border-radius: 20px;
            padding: 25px;
            max-width: 450px;
            width: 100%;
            backdrop-filter: blur(10px);
        }

        .title {
            font-size: clamp(22px, 5vw, 32px);
            text-align: center;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2, #f093fb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            text-align: center;
            opacity: 0.7;
            margin-bottom: 25px;
            font-size: 13px;
        }

        .input-group {
            margin-bottom: 18px;
        }

        .input-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 13px;
            opacity: 0.9;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #667eea;
            border-radius: 10px;
            background: rgba(0,0,0,0.3);
            color: white;
            font-size: 15px;
            outline: none;
        }

        .input-group input:focus, .input-group select:focus {
            border-color: #f093fb;
        }

        .input-group select option {
            background: #1a1a2e;
            color: white;
        }

        .btn {
            width: 100%;
            padding: 14px;
            font-size: 15px;
            font-weight: bold;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        }

        .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); }
        .btn-success { background: linear-gradient(135deg, #4caf50, #8bc34a); }
        .btn-warning { background: linear-gradient(135deg, #ff9800, #ffb74d); }
        .btn-danger { background: linear-gradient(135deg, #f44336, #ff5722); }
        .btn-secondary { background: linear-gradient(135deg, #455a64, #78909c); }
        .btn-small { padding: 10px 18px; font-size: 13px; width: auto; }

        .logo {
            font-size: 50px;
            text-align: center;
            margin-bottom: 15px;
        }

        .admin-link {
            text-align: center;
            margin-top: 20px;
            font-size: 11px;
            opacity: 0.5;
        }

        .admin-link a {
            color: #667eea;
        }

        /* ===== ë ˆë²¨ ì„ íƒ ===== */
        .level-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .level-btn {
            padding: 15px 10px;
            border: 2px solid #667eea;
            border-radius: 12px;
            background: rgba(102, 126, 234, 0.1);
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .level-btn:hover {
            background: rgba(102, 126, 234, 0.3);
            transform: scale(1.02);
        }

        .level-btn.selected {
            background: #667eea;
            border-color: #f093fb;
        }

        .level-btn .level-name {
            font-size: 15px;
            font-weight: bold;
        }

        .level-btn .level-desc {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 3px;
        }

        /* ===== ê²Œì„ í™”ë©´ ===== */
        .game-screen {
            padding: 0;
            flex-direction: column;
        }

        .game-header {
            flex-shrink: 0;
            width: 100%;
            padding: 10px 15px;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .stat-box {
            text-align: center;
            flex: 1;
        }

        .stat-label { font-size: 10px; opacity: 0.7; }
        .stat-value { font-size: 16px; font-weight: bold; }
        .stat-value.score { color: #ffd700; }
        .stat-value.wrong { color: #ff6b6b; }

        .question-box {
            flex-shrink: 0;
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, rgba(102,126,234,0.3), rgba(118,75,162,0.3));
            text-align: center;
            border-bottom: 2px solid rgba(102,126,234,0.5);
        }

        .word-label { font-size: 10px; opacity: 0.8; margin-bottom: 2px; }
        .word-korean { font-size: clamp(20px, 5vw, 28px); font-weight: bold; }

        .game-canvas-container {
            flex: 1;
            width: 100%;
            position: relative;
            overflow: hidden;
        }

        #gameCanvas { display: block; width: 100%; height: 100%; }

        /* í•˜íŠ¸ í‘œì‹œ */
        .hearts-display {
            display: flex;
            gap: 3px;
        }

        .heart {
            font-size: 18px;
        }

        .heart.lost {
            opacity: 0.3;
            filter: grayscale(1);
        }

        /* ===== ëª¨ë°”ì¼ ì»¨íŠ¸ë¡¤ ===== */
        .mobile-controls {
            display: none;
            flex-shrink: 0;
            width: 100%;
            padding: 10px;
            background: rgba(0,0,0,0.7);
        }

        @media (max-width: 768px) {
            .mobile-controls { display: flex; justify-content: space-between; align-items: center; }
        }

        .control-left {
            display: flex;
            gap: 10px;
        }

        .ctrl-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 3px solid #667eea;
            background: rgba(102, 126, 234, 0.3);
            color: white;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .ctrl-btn:active {
            background: #667eea;
        }

        .fire-btn {
            width: 75px;
            height: 75px;
            background: linear-gradient(135deg, #f44336, #ff5722);
            border-color: #ff5722;
            font-size: 13px;
            font-weight: bold;
        }

        /* ===== í”¼ë“œë°± íŒì—… ===== */
        .feedback-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            padding: 25px 40px;
            border-radius: 20px;
            font-size: clamp(18px, 4vw, 24px);
            font-weight: bold;
            text-align: center;
            z-index: 100;
            transition: transform 0.3s;
            white-space: pre-line;
            line-height: 1.4;
        }

        .feedback-popup.show {
            transform: translate(-50%, -50%) scale(1);
        }

        /* ===== ê²°ê³¼ í™”ë©´ ===== */
        .result-card {
            max-width: 420px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .result-icon {
            font-size: 60px;
            text-align: center;
            margin-bottom: 10px;
        }

        .result-title {
            font-size: clamp(22px, 5vw, 28px);
            text-align: center;
            margin-bottom: 15px;
        }

        .result-title.success { color: #4caf50; }
        .result-title.fail { color: #f44336; }

        .result-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .result-stat {
            text-align: center;
            padding: 12px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
        }

        .result-stat .value {
            font-size: 24px;
            font-weight: bold;
            color: #ffd700;
        }

        .result-stat .label {
            font-size: 11px;
            opacity: 0.7;
        }

        .wrong-words-section {
            background: rgba(244, 67, 54, 0.1);
            border: 1px solid rgba(244, 67, 54, 0.3);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .wrong-words-title {
            font-size: 14px;
            color: #ff6b6b;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .wrong-word-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 12px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .wrong-word-item .word {
            color: #ffd700;
            font-weight: bold;
        }

        .wrong-word-item .meaning {
            color: #00ff88;
        }

        /* ===== ìˆœìœ„í‘œ ===== */
        .leaderboard-card {
            max-width: 550px;
            max-height: 85vh;
        }

        .lb-list {
            max-height: 350px;
            overflow-y: auto;
        }

        .lb-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 6px;
            background: rgba(0,0,0,0.2);
        }

        .lb-item:nth-child(1) { background: rgba(255, 215, 0, 0.2); }
        .lb-item:nth-child(2) { background: rgba(192, 192, 192, 0.2); }
        .lb-item:nth-child(3) { background: rgba(205, 127, 50, 0.2); }

        .lb-rank { width: 40px; font-weight: bold; font-size: 16px; }
        .lb-info { flex: 1; }
        .lb-name { font-weight: bold; font-size: 14px; }
        .lb-detail { font-size: 11px; opacity: 0.7; }
        .lb-score { width: 80px; text-align: right; color: #ffd700; font-weight: bold; font-size: 16px; }

        /* ===== ë¡œë”© ===== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading-overlay.show { display: flex; }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.2);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* ===== ë ˆë²¨ ì§„í–‰ í‘œì‹œ ===== */
        .level-progress {
            background: rgba(0,0,0,0.3);
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
        }

        .level-progress .current-level {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
        }

        .level-progress .total-score {
            font-size: 13px;
            color: #ffd700;
            margin-top: 5px;
        }

        /* ===== ìŠ¤í¬ë¡¤ë°” ===== */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); border-radius: 3px; }
        ::-webkit-scrollbar-thumb { background: #667eea; border-radius: 3px; }

        /* ===== ë°˜ì‘í˜• ===== */
        @media (max-width: 400px) {
            .card { padding: 18px; }
            .level-grid { gap: 8px; }
            .level-btn { padding: 12px 8px; }
            .level-btn .level-name { font-size: 13px; }
            .result-stats { grid-template-columns: repeat(3, 1fr); gap: 6px; }
            .result-stat { padding: 8px; }
            .result-stat .value { font-size: 20px; }
            .ctrl-btn { width: 50px; height: 50px; font-size: 20px; }
            .fire-btn { width: 65px; height: 65px; }
        }
    </style>
</head>
<body>
    <!-- ë¡œë”© -->
    <div class="loading-overlay" id="loading">
        <div class="spinner"></div>
    </div>

    <!-- í”¼ë“œë°± íŒì—… -->
    <div class="feedback-popup" id="feedbackPopup"></div>

    <!-- ===== ë¡œê·¸ì¸ í™”ë©´ ===== -->
    <div class="screen active" id="loginScreen">
        <div class="card">
            <div style="text-align:center; margin-bottom:15px;">
                <div style="font-size:12px; color:#667eea; letter-spacing:1px;">ìš°ì†¡ëŒ€í•™êµ AIê²½ì˜í•™ê³¼</div>
                <div style="font-size:14px; color:#f093fb; font-weight:bold; margin-top:3px;">ğŸ“ ê²Œì„ê¸°ë°˜ í•™ìŠµí”Œë«í¼</div>
            </div>
            <div class="logo">ğŸš€</div>
            <h1 class="title">í† ìµ ì˜ë‹¨ì–´ ê°¤ëŸ¬ê·¸</h1>
            <p class="subtitle">TOEIC Vocabulary Learning Game</p>

            <div class="input-group">
                <label>í•™ë²ˆ (Student ID)</label>
                <input type="text" id="studentId" placeholder="í•™ë²ˆ ì…ë ¥ / Enter Student ID" maxlength="20">
            </div>

            <div class="input-group">
                <label>ì´ë¦„ (Name)</label>
                <input type="text" id="playerName" placeholder="ì´ë¦„ ì…ë ¥ / Enter Name" maxlength="10">
            </div>

            <button class="btn btn-primary" onclick="login()">ğŸ® ì‹œì‘í•˜ê¸° (Start)</button>
            <button class="btn btn-secondary" onclick="showScreen('leaderboardScreen')">ğŸ† ìˆœìœ„ ë³´ê¸° (Ranking)</button>

            <div class="admin-link">
                <a href="admin.html">ğŸ”§ ê´€ë¦¬ì ëª¨ë“œ (Admin)</a>
            </div>
        </div>
    </div>

    <!-- ===== ë ˆë²¨ ì„ íƒ í™”ë©´ ===== -->
    <div class="screen" id="levelScreen">
        <div class="card">
            <div style="text-align:center; margin-bottom:10px; font-size:11px;">
                <span style="color:#667eea;">ğŸ“ ìš°ì†¡ëŒ€í•™êµ AIê²½ì˜í•™ê³¼</span>
                <span style="color:#f093fb; margin-left:5px;">ê²Œì„ê¸°ë°˜ í•™ìŠµí”Œë«í¼</span>
            </div>
            <h2 class="title">ğŸ“š ë ˆë²¨ ì„ íƒ</h2>
            <p class="subtitle">ëª©í‘œ í† ìµ ì ìˆ˜ë¥¼ ì„ íƒí•˜ì„¸ìš”</p>

            <!-- ëˆ„ì  ì ìˆ˜ í‘œì‹œ -->
            <div class="level-progress" id="levelProgressBox" style="display:none;">
                <div class="current-level">í˜„ì¬ ì§„í–‰: <span id="currentLevelText">-</span></div>
                <div class="total-score">ğŸ† ëˆ„ì  ì ìˆ˜: <span id="totalScoreText">0</span>ì </div>
            </div>

            <div class="level-grid">
                <div class="level-btn" onclick="selectLevel(300)">
                    <div class="level-name">300ì </div>
                    <div class="level-desc">ì…ë¬¸</div>
                </div>
                <div class="level-btn" onclick="selectLevel(400)">
                    <div class="level-name">400ì </div>
                    <div class="level-desc">ê¸°ì´ˆ</div>
                </div>
                <div class="level-btn" onclick="selectLevel(500)">
                    <div class="level-name">500ì </div>
                    <div class="level-desc">ì´ˆê¸‰</div>
                </div>
                <div class="level-btn" onclick="selectLevel(600)">
                    <div class="level-name">600ì </div>
                    <div class="level-desc">ì¤‘ê¸‰</div>
                </div>
                <div class="level-btn" onclick="selectLevel(700)">
                    <div class="level-name">700ì </div>
                    <div class="level-desc">ì¤‘ìƒê¸‰</div>
                </div>
                <div class="level-btn" onclick="selectLevel(800)">
                    <div class="level-name">800ì </div>
                    <div class="level-desc">ìƒê¸‰</div>
                </div>
                <div class="level-btn" onclick="selectLevel(900)">
                    <div class="level-name">900ì </div>
                    <div class="level-desc">ê³ ê¸‰</div>
                </div>
                <div class="level-btn" onclick="selectLevel(1000)">
                    <div class="level-name">990+</div>
                    <div class="level-desc">ë§Œì </div>
                </div>
            </div>

            <button class="btn btn-secondary" onclick="showScreen('loginScreen')">â† ì²˜ìŒìœ¼ë¡œ</button>
        </div>
    </div>

    <!-- ===== ê²Œì„ í™”ë©´ ===== -->
    <div class="screen game-screen" id="gameScreen">
        <div style="flex-shrink:0; width:100%; padding:6px 10px; background:linear-gradient(90deg, rgba(102,126,234,0.3), rgba(240,147,251,0.3)); text-align:center; font-size:11px; letter-spacing:0.5px;">
            <span style="color:#fff;">ğŸ“ ìš°ì†¡ëŒ€í•™êµ AIê²½ì˜í•™ê³¼</span>
            <span style="color:#ffd700; margin-left:8px;">ê²Œì„ê¸°ë°˜ í•™ìŠµí”Œë«í¼</span>
        </div>
        <div class="game-header">
            <div class="stat-box">
                <div class="stat-label">ë ˆë²¨ ì ìˆ˜</div>
                <div class="stat-value score" id="scoreDisplay">0</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">ë¬¸ì œ</div>
                <div class="stat-value" id="questionDisplay">1/?</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">ë‚¨ì€ ê¸°íšŒ</div>
                <div class="hearts-display" id="heartsDisplay">
                    <span class="heart">â¤ï¸</span>
                    <span class="heart">â¤ï¸</span>
                    <span class="heart">â¤ï¸</span>
                    <span class="heart">â¤ï¸</span>
                    <span class="heart">â¤ï¸</span>
                </div>
            </div>
        </div>

        <div class="question-box">
            <div class="word-label">ì´ ëœ»ì„ ê°€ì§„ ì˜ë‹¨ì–´ëŠ”?</div>
            <div class="word-korean" id="koreanWord">-</div>
        </div>

        <div class="game-canvas-container">
            <canvas id="gameCanvas"></canvas>
        </div>

        <div class="mobile-controls">
            <div class="control-left">
                <button class="ctrl-btn" id="leftBtn">â—€</button>
                <button class="ctrl-btn" id="rightBtn">â–¶</button>
            </div>
            <button class="ctrl-btn fire-btn" id="fireBtn">ğŸ’¥ ë°œì‚¬</button>
        </div>
    </div>

    <!-- ===== ê²°ê³¼ í™”ë©´ ===== -->
    <div class="screen" id="resultScreen">
        <div class="card result-card">
            <div style="text-align:center; margin-bottom:10px; font-size:11px;">
                <span style="color:#667eea;">ğŸ“ ìš°ì†¡ëŒ€í•™êµ AIê²½ì˜í•™ê³¼</span>
                <span style="color:#f093fb; margin-left:5px;">ê²Œì„ê¸°ë°˜ í•™ìŠµí”Œë«í¼</span>
            </div>
            <div class="result-icon" id="resultIcon">ğŸ‰</div>
            <h2 class="result-title" id="resultTitle">ë¯¸ì…˜ ì„±ê³µ!</h2>

            <div class="result-stats">
                <div class="result-stat">
                    <div class="value" id="resultLevelScore">0</div>
                    <div class="label">ë ˆë²¨ ì ìˆ˜</div>
                </div>
                <div class="result-stat">
                    <div class="value" id="resultCorrect">0</div>
                    <div class="label">ì •ë‹µ</div>
                </div>
                <div class="result-stat">
                    <div class="value" id="resultWrong">0</div>
                    <div class="label">ì˜¤ë‹µ</div>
                </div>
            </div>

            <!-- ëˆ„ì  ì ìˆ˜ -->
            <div class="level-progress">
                <div class="total-score" style="font-size:16px;">ğŸ† ëˆ„ì  ì´ì : <span id="resultTotalScore" style="font-size:22px;">0</span>ì </div>
            </div>

            <!-- í‹€ë¦° ë‹¨ì–´ ë³µìŠµ -->
            <div class="wrong-words-section" id="wrongWordsSection" style="display:none;">
                <div class="wrong-words-title">ğŸ“š í‹€ë¦° ë‹¨ì–´ ë³µìŠµ (ë‹¤ì‹œ í‹€ë¦¬ì§€ ì•Šë„ë¡!)</div>
                <div id="wrongWordsList"></div>
            </div>

            <div id="resultButtons">
                <!-- ë™ì ìœ¼ë¡œ ë²„íŠ¼ ì¶”ê°€ -->
            </div>
        </div>
    </div>

    <!-- ===== ìˆœìœ„í‘œ í™”ë©´ ===== -->
    <div class="screen" id="leaderboardScreen">
        <div class="card leaderboard-card">
            <div style="text-align:center; margin-bottom:10px; font-size:11px;">
                <span style="color:#667eea;">ğŸ“ ìš°ì†¡ëŒ€í•™êµ AIê²½ì˜í•™ê³¼</span>
                <span style="color:#f093fb; margin-left:5px;">ê²Œì„ê¸°ë°˜ í•™ìŠµí”Œë«í¼</span>
            </div>
            <h2 class="title">ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹</h2>
            <p class="subtitle">ëˆ„ì  ì´ì  ê¸°ì¤€ ìˆœìœ„</p>

            <div class="lb-list" id="leaderboardList">
                <!-- ë™ì  ë¡œë“œ -->
            </div>

            <button class="btn btn-secondary" onclick="goBackFromLeaderboard()" style="margin-top:15px;">â† ëŒì•„ê°€ê¸°</button>
        </div>
    </div>

    <script>
        // ========================================
        // Firebase ì„¤ì •
        // ========================================
        const firebaseConfig = {
            apiKey: "AIzaSyA6NONPoeAGHcMLkLwPunduIGqmODUQnAQ",
  authDomain: "toeic-voca-30c67.firebaseapp.com",
  databaseURL: "https://toeic-voca-30c67-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "toeic-voca-30c67",
  storageBucket: "toeic-voca-30c67.firebasestorage.app",
  messagingSenderId: "740332360254",
  appId: "1:740332360254:web:c04edc2988a6e6f63f776f",
  measurementId: "G-9E8HXE4LJ7"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // ========================================
        // ê¸°ë³¸ ë‹¨ì–´ ë°ì´í„°
        // ========================================
        const defaultWords = {
            300: [
                {word: 'book', meaning: 'ì±…'}, {word: 'water', meaning: 'ë¬¼'},
                {word: 'food', meaning: 'ìŒì‹'}, {word: 'work', meaning: 'ì¼í•˜ë‹¤'},
                {word: 'time', meaning: 'ì‹œê°„'}, {word: 'money', meaning: 'ëˆ'},
                {word: 'house', meaning: 'ì§‘'}, {word: 'family', meaning: 'ê°€ì¡±'},
                {word: 'friend', meaning: 'ì¹œêµ¬'}, {word: 'school', meaning: 'í•™êµ'},
                {word: 'phone', meaning: 'ì „í™”'}, {word: 'email', meaning: 'ì´ë©”ì¼'},
                {word: 'meeting', meaning: 'íšŒì˜'}, {word: 'office', meaning: 'ì‚¬ë¬´ì‹¤'},
                {word: 'company', meaning: 'íšŒì‚¬'}, {word: 'customer', meaning: 'ê³ ê°'}
            ],
            400: [
                {word: 'available', meaning: 'ì´ìš© ê°€ëŠ¥í•œ'}, {word: 'provide', meaning: 'ì œê³µí•˜ë‹¤'},
                {word: 'include', meaning: 'í¬í•¨í•˜ë‹¤'}, {word: 'require', meaning: 'ìš”êµ¬í•˜ë‹¤'},
                {word: 'schedule', meaning: 'ì¼ì •'}, {word: 'confirm', meaning: 'í™•ì¸í•˜ë‹¤'},
                {word: 'attend', meaning: 'ì°¸ì„í•˜ë‹¤'}, {word: 'contact', meaning: 'ì—°ë½í•˜ë‹¤'},
                {word: 'department', meaning: 'ë¶€ì„œ'}, {word: 'employee', meaning: 'ì§ì›'},
                {word: 'manager', meaning: 'ê´€ë¦¬ì'}, {word: 'position', meaning: 'ì§ìœ„'},
                {word: 'experience', meaning: 'ê²½í—˜'}, {word: 'opportunity', meaning: 'ê¸°íšŒ'},
                {word: 'improve', meaning: 'ê°œì„ í•˜ë‹¤'}, {word: 'develop', meaning: 'ê°œë°œí•˜ë‹¤'}
            ],
            500: [
                {word: 'announce', meaning: 'ë°œí‘œí•˜ë‹¤'}, {word: 'approximately', meaning: 'ëŒ€ëµ'},
                {word: 'arrange', meaning: 'ì¤€ë¹„í•˜ë‹¤'}, {word: 'budget', meaning: 'ì˜ˆì‚°'},
                {word: 'candidate', meaning: 'í›„ë³´ì'}, {word: 'competitive', meaning: 'ê²½ìŸë ¥ ìˆëŠ”'},
                {word: 'currently', meaning: 'í˜„ì¬'}, {word: 'deadline', meaning: 'ë§ˆê°ì¼'},
                {word: 'determine', meaning: 'ê²°ì •í•˜ë‹¤'}, {word: 'effective', meaning: 'íš¨ê³¼ì ì¸'},
                {word: 'establish', meaning: 'ì„¤ë¦½í•˜ë‹¤'}, {word: 'facility', meaning: 'ì‹œì„¤'},
                {word: 'generate', meaning: 'ìƒì„±í•˜ë‹¤'}, {word: 'implement', meaning: 'ì‹¤í–‰í•˜ë‹¤'},
                {word: 'inventory', meaning: 'ì¬ê³ '}, {word: 'negotiate', meaning: 'í˜‘ìƒí•˜ë‹¤'}
            ],
            600: [
                {word: 'accomplish', meaning: 'ì„±ì·¨í•˜ë‹¤'}, {word: 'adequate', meaning: 'ì ì ˆí•œ'},
                {word: 'anticipate', meaning: 'ì˜ˆìƒí•˜ë‹¤'}, {word: 'apparent', meaning: 'ëª…ë°±í•œ'},
                {word: 'comprehensive', meaning: 'í¬ê´„ì ì¸'}, {word: 'consecutive', meaning: 'ì—°ì†ì ì¸'},
                {word: 'considerable', meaning: 'ìƒë‹¹í•œ'}, {word: 'consistently', meaning: 'ì¼ê´€ë˜ê²Œ'},
                {word: 'demonstrate', meaning: 'ë³´ì—¬ì£¼ë‹¤'}, {word: 'dimension', meaning: 'ì°¨ì›'},
                {word: 'distribute', meaning: 'ë°°í¬í•˜ë‹¤'}, {word: 'eligible', meaning: 'ìê²©ì´ ìˆëŠ”'},
                {word: 'enhance', meaning: 'í–¥ìƒì‹œí‚¤ë‹¤'}, {word: 'enthusiastic', meaning: 'ì—´ì •ì ì¸'},
                {word: 'essential', meaning: 'í•„ìˆ˜ì ì¸'}, {word: 'exceptional', meaning: 'ë›°ì–´ë‚œ'}
            ],
            700: [
                {word: 'accommodate', meaning: 'ìˆ˜ìš©í•˜ë‹¤'}, {word: 'acquisition', meaning: 'ì¸ìˆ˜'},
                {word: 'adjacent', meaning: 'ì¸ì ‘í•œ'}, {word: 'aggregate', meaning: 'í•©ê³„'},
                {word: 'alleviate', meaning: 'ì™„í™”í•˜ë‹¤'}, {word: 'anticipate', meaning: 'ì˜ˆìƒí•˜ë‹¤'},
                {word: 'autonomous', meaning: 'ììœ¨ì ì¸'}, {word: 'benchmark', meaning: 'ê¸°ì¤€ì '},
                {word: 'consolidate', meaning: 'í†µí•©í•˜ë‹¤'}, {word: 'contingency', meaning: 'ë¹„ìƒì‚¬íƒœ'},
                {word: 'deteriorate', meaning: 'ì•…í™”ë˜ë‹¤'}, {word: 'discretion', meaning: 'ì¬ëŸ‰'},
                {word: 'diversify', meaning: 'ë‹¤ì–‘í™”í•˜ë‹¤'}, {word: 'elaborate', meaning: 'ì •êµí•œ'},
                {word: 'encompass', meaning: 'í¬í•¨í•˜ë‹¤'}, {word: 'expedite', meaning: 'ì‹ ì†íˆ ì²˜ë¦¬í•˜ë‹¤'}
            ],
            800: [
                {word: 'meticulous', meaning: 'ê¼¼ê¼¼í•œ'}, {word: 'pragmatic', meaning: 'ì‹¤ìš©ì ì¸'},
                {word: 'unprecedented', meaning: 'ì „ë¡€ ì—†ëŠ”'}, {word: 'substantiate', meaning: 'ì…ì¦í•˜ë‹¤'},
                {word: 'circumvent', meaning: 'ìš°íšŒí•˜ë‹¤'}, {word: 'delineate', meaning: 'ë¬˜ì‚¬í•˜ë‹¤'},
                {word: 'exacerbate', meaning: 'ì•…í™”ì‹œí‚¤ë‹¤'}, {word: 'extrapolate', meaning: 'ì¶”ì •í•˜ë‹¤'},
                {word: 'inadvertent', meaning: 'ë¶€ì£¼ì˜í•œ'}, {word: 'juxtapose', meaning: 'ë‚˜ë€íˆ ë†“ë‹¤'},
                {word: 'mitigate', meaning: 'ì™„í™”ì‹œí‚¤ë‹¤'}, {word: 'corroborate', meaning: 'í™•ì¦í•˜ë‹¤'},
                {word: 'proliferate', meaning: 'ê¸‰ì¦í•˜ë‹¤'}, {word: 'scrutinize', meaning: 'ë©´ë°€íˆ ì¡°ì‚¬í•˜ë‹¤'},
                {word: 'superfluous', meaning: 'ë¶ˆí•„ìš”í•œ'}, {word: 'ubiquitous', meaning: 'ì–´ë””ì—ë‚˜ ìˆëŠ”'}
            ],
            900: [
                {word: 'ameliorate', meaning: 'ê°œì„ í•˜ë‹¤'}, {word: 'ancillary', meaning: 'ë³´ì¡°ì ì¸'},
                {word: 'antipathy', meaning: 'ë°˜ê°'}, {word: 'assiduous', meaning: 'ê·¼ë©´í•œ'},
                {word: 'belligerent', meaning: 'í˜¸ì „ì ì¸'}, {word: 'burgeoning', meaning: 'ê¸‰ì„±ì¥í•˜ëŠ”'},
                {word: 'capitulate', meaning: 'í•­ë³µí•˜ë‹¤'}, {word: 'cogent', meaning: 'ì„¤ë“ë ¥ ìˆëŠ”'},
                {word: 'conundrum', meaning: 'ë‚œì œ'}, {word: 'deleterious', meaning: 'í•´ë¡œìš´'},
                {word: 'egregious', meaning: 'ì§€ë…í•œ'}, {word: 'ephemeral', meaning: 'ì¼ì‹œì ì¸'},
                {word: 'fastidious', meaning: 'ê¹Œë‹¤ë¡œìš´'}, {word: 'fortuitous', meaning: 'ìš°ì—°í•œ'},
                {word: 'garrulous', meaning: 'ìˆ˜ë‹¤ìŠ¤ëŸ¬ìš´'}, {word: 'hackneyed', meaning: 'ì§„ë¶€í•œ'}
            ],
            1000: [
                {word: 'abstruse', meaning: 'ë‚œí•´í•œ'}, {word: 'acrimonious', meaning: 'ì‹ ë„í•œ'},
                {word: 'apotheosis', meaning: 'ê·¹ì¹˜'}, {word: 'churlish', meaning: 'ë¬´ë¡€í•œ'},
                {word: 'conflagration', meaning: 'ëŒ€í™”ì¬'}, {word: 'contrite', meaning: 'ë‰˜ìš°ì¹˜ëŠ”'},
                {word: 'desiccate', meaning: 'ê±´ì¡°ì‹œí‚¤ë‹¤'}, {word: 'dilatory', meaning: 'ì§€ì—°ì‹œí‚¤ëŠ”'},
                {word: 'enervate', meaning: 'ê¸°ë ¥ì„ ë¹¼ë‹¤'}, {word: 'equanimity', meaning: 'í‰ì •ì‹¬'},
                {word: 'loquacious', meaning: 'ë§ì´ ë§ì€'}, {word: 'magnanimous', meaning: 'ê´€ëŒ€í•œ'},
                {word: 'obsequious', meaning: 'ì•„ì²¨í•˜ëŠ”'}, {word: 'perfunctory', meaning: 'í˜•ì‹ì ì¸'},
                {word: 'recalcitrant', meaning: 'ë°˜í•­ì ì¸'}, {word: 'sycophant', meaning: 'ì•„ì²¨ê¾¼'}
            ]
        };

        // ========================================
        // ê²Œì„ ìƒíƒœ
        // ========================================
        let player = {
            studentId: '',
            name: '',
            totalScore: 0,          // ëˆ„ì  ì´ì 
            currentLevel: 300,
            passedLevels: []        // í†µê³¼í•œ ë ˆë²¨ë“¤
        };

        let game = {
            canvas: null,
            ctx: null,
            width: 0,
            height: 0,
            running: false,
            words: [],
            usedWordIndices: [],    // ì´ë¯¸ ì¶œì œí•œ ë‹¨ì–´ ì¸ë±ìŠ¤
            currentWord: null,
            questionNumber: 0,
            totalQuestions: 0,      // í•´ë‹¹ ë ˆë²¨ ì´ ë¬¸ì œ ìˆ˜
            score: 0,               // í˜„ì¬ ë ˆë²¨ ì ìˆ˜
            correctCount: 0,
            wrongCount: 0,          // í‹€ë¦° íšŸìˆ˜ (5ë²ˆ ë˜ë©´ ê²Œì„ì˜¤ë²„)
            maxWrong: 5,            // ìµœëŒ€ í‹€ë¦° íšŸìˆ˜
            wrongWords: [],
            questionAnswered: false,
            streak: 0,              // ì—°ì† ì •ë‹µ ì¹´ìš´í„°
            ship: { x: 0, y: 0, width: 40, height: 40, speed: 8 },
            bullets: [],
            enemies: [],
            particles: [],
            confetti: [],           // í’ì„ í­ì£½ íŒŒí‹°í´
            keys: {},
            touchX: null,
            lastTime: 0,
            animFrame: null,
            scaleFactor: 1          // ëª¨ë°”ì¼ ìŠ¤ì¼€ì¼ íŒ©í„°
        };

        // ========================================
        // í™”ë©´ ì „í™˜
        // ========================================
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            
            if (screenId === 'leaderboardScreen') {
                loadLeaderboard();
            }
            if (screenId === 'levelScreen') {
                updateLevelProgressDisplay();
            }
        }

        function showLoading(show) {
            document.getElementById('loading').classList.toggle('show', show);
        }

        function showFeedback(text, color) {
            const popup = document.getElementById('feedbackPopup');
            popup.textContent = text;
            popup.style.background = color;
            popup.classList.add('show');
            setTimeout(() => popup.classList.remove('show'), 1200);
        }

        // ========================================
        // ë¡œê·¸ì¸
        // ========================================
        function login() {
            const studentId = document.getElementById('studentId').value.trim();
            const name = document.getElementById('playerName').value.trim();
            
            if (!studentId || !name) {
                showFeedback('í•™ë²ˆê³¼ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”', '#f44336');
                return;
            }
            
            player.studentId = studentId;
            player.name = name;
            player.totalScore = 0;
            player.passedLevels = [];
            
            showScreen('levelScreen');
        }

        // ========================================
        // ë ˆë²¨ ì„ íƒ
        // ========================================
        function selectLevel(level) {
            player.currentLevel = level;
            
            document.querySelectorAll('.level-btn').forEach(btn => btn.classList.remove('selected'));
            event.target.closest('.level-btn').classList.add('selected');
            
            startGame();
        }

        function updateLevelProgressDisplay() {
            const box = document.getElementById('levelProgressBox');
            if (player.totalScore > 0 || player.passedLevels.length > 0) {
                box.style.display = 'block';
                document.getElementById('currentLevelText').textContent = 
                    player.passedLevels.length > 0 ? `${player.passedLevels[player.passedLevels.length - 1]}ì  í†µê³¼!` : '-';
                document.getElementById('totalScoreText').textContent = player.totalScore;
            } else {
                box.style.display = 'none';
            }
        }

        // ========================================
        // ê²Œì„ ì‹œì‘
        // ========================================
        async function startGame() {
            showLoading(true);
            
            try {
                // Firebaseì—ì„œ ë‹¨ì–´ ë¡œë“œ
                const snapshot = await database.ref(`toeic_galaga/words/level${player.currentLevel}`).once('value');
                
                if (snapshot.exists()) {
                    game.words = [];
                    snapshot.forEach(child => {
                        game.words.push(child.val());
                    });
                } else {
                    game.words = [...defaultWords[player.currentLevel]];
                }
                
                if (game.words.length < 4) {
                    showFeedback('ë‹¨ì–´ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤', '#f44336');
                    showLoading(false);
                    return;
                }
                
                showLoading(false);
                showScreen('gameScreen');
                
                // í™”ë©´ ì „í™˜ í›„ ìº”ë²„ìŠ¤ í¬ê¸°ê°€ ì œëŒ€ë¡œ ê³„ì‚°ë˜ë„ë¡ ì§€ì—° ì´ˆê¸°í™”
                setTimeout(() => {
                    initGame();
                    requestAnimationFrame(gameLoop);
                }, 100);
                
            } catch (error) {
                console.error('Error loading words:', error);
                game.words = [...defaultWords[player.currentLevel]];
                showLoading(false);
                showScreen('gameScreen');
                
                // í™”ë©´ ì „í™˜ í›„ ìº”ë²„ìŠ¤ í¬ê¸°ê°€ ì œëŒ€ë¡œ ê³„ì‚°ë˜ë„ë¡ ì§€ì—° ì´ˆê¸°í™”
                setTimeout(() => {
                    initGame();
                    requestAnimationFrame(gameLoop);
                }, 100);
            }
        }

        function initGame() {
            game.canvas = document.getElementById('gameCanvas');
            game.ctx = game.canvas.getContext('2d');
            
            resizeCanvas();
            
            // ê²Œì„ ìƒíƒœ ì´ˆê¸°í™”
            game.running = true;
            game.score = 0;
            game.correctCount = 0;
            game.wrongCount = 0;
            game.questionNumber = 0;
            game.totalQuestions = game.words.length;
            game.usedWordIndices = [];
            game.wrongWords = [];
            game.bullets = [];
            game.enemies = [];
            game.particles = [];
            game.confetti = [];
            game.streak = 0;
            game.questionAnswered = false;
            
            // ìš°ì£¼ì„  ìœ„ì¹˜
            game.ship.x = game.width / 2 - game.ship.width / 2;
            game.ship.y = game.height - game.ship.height - 20;
            
            // í•˜íŠ¸ ì—…ë°ì´íŠ¸
            updateHeartsDisplay();
            
            // ì²« ë¬¸ì œ ì‹œì‘
            nextQuestion();
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            setupControls();
        }

        function resizeCanvas() {
            const container = game.canvas.parentElement;
            let width = container.clientWidth;
            let height = container.clientHeight;
            
            // í¬ê¸°ê°€ 0ì¸ ê²½ìš° ê¸°ë³¸ê°’ ì„¤ì • (ì•ˆì „ì¥ì¹˜)
            if (width === 0 || height === 0) {
                width = window.innerWidth;
                height = window.innerHeight - 200;  // ìƒë‹¨ UI ê³µê°„ ì œì™¸
            }
            
            game.canvas.width = width;
            game.canvas.height = height;
            game.width = width;
            game.height = height;
            
            // ëª¨ë°”ì¼ ìŠ¤ì¼€ì¼ íŒ©í„° ê³„ì‚° (ê¸°ì¤€: 400px)
            game.scaleFactor = Math.min(1, game.width / 400);
        }

        // ========================================
        // í•˜íŠ¸ í‘œì‹œ ì—…ë°ì´íŠ¸
        // ========================================
        function updateHeartsDisplay() {
            const container = document.getElementById('heartsDisplay');
            let html = '';
            for (let i = 0; i < game.maxWrong; i++) {
                if (i < game.maxWrong - game.wrongCount) {
                    html += '<span class="heart">â¤ï¸</span>';
                } else {
                    html += '<span class="heart lost">ğŸ–¤</span>';
                }
            }
            container.innerHTML = html;
        }

        // ========================================
        // ë‹¤ìŒ ë¬¸ì œ
        // ========================================
        function nextQuestion() {
            // ëª¨ë“  ë¬¸ì œë¥¼ ë‹¤ í’€ì—ˆëŠ”ì§€ í™•ì¸
            if (game.usedWordIndices.length >= game.words.length) {
                // ë¯¸ì…˜ ì„±ê³µ!
                missionSuccess();
                return;
            }
            
            game.questionNumber++;
            game.questionAnswered = false;
            game.enemies = [];
            game.bullets = [];
            
            // ì•„ì§ ì•ˆ ë‚˜ì˜¨ ë‹¨ì–´ ì¤‘ì—ì„œ ì„ íƒ
            let availableIndices = [];
            for (let i = 0; i < game.words.length; i++) {
                if (!game.usedWordIndices.includes(i)) {
                    availableIndices.push(i);
                }
            }
            
            const randomIndex = availableIndices[Math.floor(Math.random() * availableIndices.length)];
            game.usedWordIndices.push(randomIndex);
            game.currentWord = game.words[randomIndex];
            
            // UI ì—…ë°ì´íŠ¸
            document.getElementById('koreanWord').textContent = game.currentWord.meaning;
            document.getElementById('scoreDisplay').textContent = game.score;
            document.getElementById('questionDisplay').textContent = `${game.questionNumber}/${game.totalQuestions}`;
            
            // ì  ìƒì„±
            spawnEnemies();
        }

        // ========================================
        // ì  ìƒì„± (ì˜ì–´ ë‹¨ì–´ ë¸”ë¡)
        // ========================================
        function spawnEnemies() {
            const correctWord = game.currentWord.word;
            
            // ì˜¤ë‹µ ë‹¨ì–´ ì„ íƒ
            const otherWords = game.words
                .filter(w => w.word !== correctWord)
                .map(w => w.word);
            const wrongWords = shuffleArray([...otherWords]).slice(0, 3);
            
            const allOptions = shuffleArray([
                { text: correctWord, isCorrect: true },
                ...wrongWords.map(w => ({ text: w, isCorrect: false }))
            ]);
            
            // í™”ë©´ ë„ˆë¹„ì— ë§ê²Œ ë¸”ë¡ í¬ê¸° ë™ì  ê³„ì‚°
            const padding = 10;  // ì¢Œìš° ì—¬ë°±
            const gap = 8;       // ë¸”ë¡ ê°„ ê°„ê²©
            const availableWidth = game.width - (padding * 2);
            
            // ëª¨ë°”ì¼ì—ì„œëŠ” 2x2 ê·¸ë¦¬ë“œ, PCì—ì„œëŠ” 1x4 ê°€ë¡œ ë°°ì¹˜
            const isMobile = game.width < 500;
            
            let blockWidth, blockHeight, cols, rows;
            
            if (isMobile) {
                // ëª¨ë°”ì¼: 2x2 ê·¸ë¦¬ë“œ
                cols = 2;
                rows = 2;
                blockWidth = Math.min(120, (availableWidth - gap) / 2);
                blockHeight = 50;
            } else {
                // PC: 1x4 ê°€ë¡œ ë°°ì¹˜
                cols = 4;
                rows = 1;
                blockWidth = Math.min(130, (availableWidth - gap * 3) / 4);
                blockHeight = 55;
            }
            
            const totalGridWidth = (blockWidth * cols) + (gap * (cols - 1));
            const startX = (game.width - totalGridWidth) / 2;
            
            allOptions.forEach((option, i) => {
                let col, row;
                if (isMobile) {
                    col = i % 2;
                    row = Math.floor(i / 2);
                } else {
                    col = i;
                    row = 0;
                }
                
                game.enemies.push({
                    x: startX + col * (blockWidth + gap),
                    y: -60 - row * (blockHeight + gap + 10) - (isMobile ? 0 : i * 20),
                    width: blockWidth,
                    height: blockHeight,
                    speed: 0.7 + Math.random() * 0.3,
                    text: option.text,
                    isCorrect: option.isCorrect,
                    type: 'main',
                    color: '#3949ab',
                    glowColor: '#7986cb',
                    destroyed: false,
                    wobbleOffset: Math.random() * Math.PI * 2,
                    baseX: startX + col * (blockWidth + gap),  // ê¸°ì¤€ X ìœ„ì¹˜ ì €ì¥
                    maxWobble: Math.min(15, (game.width - totalGridWidth) / 4)  // ìµœëŒ€ ì¢Œìš° í”ë“¤ë¦¼
                });
            });
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // ========================================
        // ë°œì‚¬ (ëŒ€í¬ì•Œ)
        // ========================================
        function shoot() {
            if (!game.running || game.bullets.length >= 3) return;
            
            game.bullets.push({
                x: game.ship.x + game.ship.width / 2,
                y: game.ship.y - 10,
                radius: 12,  // ëŒ€í¬ì•Œ ë°˜ì§€ë¦„
                speed: 10,
                glow: 1
            });
            
            // ëŒ€í¬ ë°œì‚¬ ì‚¬ìš´ë“œ (ì¿µ!)
            playSound(150, 0.3, 'triangle');
            setTimeout(() => playSound(100, 0.2, 'triangle'), 50);
        }

        // ========================================
        // ê²Œì„ ë£¨í”„
        // ========================================
        function gameLoop(timestamp) {
            if (!game.running) return;
            
            // ìº”ë²„ìŠ¤ í¬ê¸°ê°€ 0ì´ë©´ ë‹¤ì‹œ ì´ˆê¸°í™”
            if (game.width === 0 || game.height === 0) {
                resizeCanvas();
                game.ship.x = game.width / 2 - game.ship.width / 2;
                game.ship.y = game.height - game.ship.height - 20;
            }
            
            const dt = timestamp - game.lastTime;
            game.lastTime = timestamp;
            
            update(dt);
            render();
            
            game.animFrame = requestAnimationFrame(gameLoop);
        }

        function update(dt) {
            // ìš°ì£¼ì„  ì´ë™
            if (game.keys['ArrowLeft'] || game.keys['KeyA']) {
                game.ship.x -= game.ship.speed;
            }
            if (game.keys['ArrowRight'] || game.keys['KeyD']) {
                game.ship.x += game.ship.speed;
            }
            
            // í„°ì¹˜ ì´ë™
            if (game.touchX !== null) {
                const targetX = game.touchX - game.ship.width / 2;
                game.ship.x += (targetX - game.ship.x) * 0.15;
            }
            
            // ê²½ê³„ ì²´í¬
            game.ship.x = Math.max(0, Math.min(game.width - game.ship.width, game.ship.x));
            
            // ëŒ€í¬ì•Œ ì´ë™
            game.bullets = game.bullets.filter(b => {
                b.y -= b.speed;
                return b.y > -b.radius;  // ëŒ€í¬ì•Œ ë°˜ì§€ë¦„ ê¸°ì¤€
            });
            
            // ì  ì´ë™ ë° ì¶©ëŒ ì²´í¬
            let mainEnemyCount = 0;
            let allMainEnemiesGone = true;
            
            game.enemies.forEach(enemy => {
                if (enemy.destroyed) return;
                
                if (enemy.type === 'main') {
                    mainEnemyCount++;
                    if (enemy.y < game.height) {
                        allMainEnemiesGone = false;
                    }
                }
                
                enemy.y += enemy.speed;
                
                // ì¢Œìš° í”ë“¤ë¦¼ (í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°€ì§€ ì•Šë„ë¡ ì œí•œ)
                const wobble = Math.sin(Date.now() / 500 + enemy.wobbleOffset) * (enemy.maxWobble || 10);
                const newX = (enemy.baseX || enemy.x) + wobble;
                
                // í™”ë©´ ê²½ê³„ ì²´í¬
                if (newX >= 5 && newX + enemy.width <= game.width - 5) {
                    enemy.x = newX;
                }
                
                // ì¶©ëŒ ì²´í¬
                game.bullets.forEach((bullet, bi) => {
                    if (checkCollision(bullet, enemy)) {
                        game.bullets.splice(bi, 1);
                        enemy.destroyed = true;
                        
                        if (enemy.isCorrect) {
                            createExplosion(enemy.x + enemy.width/2, enemy.y + enemy.height/2, '#00ff88');
                            game.score += 100;
                            game.correctCount++;
                            game.streak++;  // ì—°ì† ì •ë‹µ ì¦ê°€
                            game.questionAnswered = true;
                            playSound(523, 0.3, 'sine');
                            
                            // 5ì—°ì† ì •ë‹µë§ˆë‹¤ í’ì„ í­ì£½!
                            if (game.streak > 0 && game.streak % 5 === 0) {
                                createConfetti();
                                // ë ˆë²¨ë³„ ë³´ë„ˆìŠ¤ ì ìˆ˜ (300=1000, 400=2000, ... 1000=8000)
                                const bonusMultiplier = Math.floor((player.currentLevel - 300) / 100) + 1;
                                const bonusScore = bonusMultiplier * 1000;
                                game.score += bonusScore;
                                showFeedback(`ğŸŠğŸˆ ${game.streak}ì—°ì† ì •ë‹µ! ğŸˆğŸŠ\nğŸ +${bonusScore.toLocaleString()}ì  ë³´ë„ˆìŠ¤!`, '#ff6b9d');
                                playSound(784, 0.3, 'sine');
                                setTimeout(() => playSound(988, 0.3, 'sine'), 100);
                                setTimeout(() => playSound(1175, 0.3, 'sine'), 200);
                            } else {
                                // ë‹¤ì–‘í•œ ì¹­ì°¬ ë©”ì‹œì§€
                                const praises = [
                                    'ğŸ‰ ì •ë‹µ! ëŒ€ë‹¨í•´ìš”!',
                                    'â­ ì™„ë²½í•´ìš”! ì²œì¬!',
                                    'ğŸ”¥ ë¶ˆíƒ€ëŠ” ì‹¤ë ¥!',
                                    'ğŸ’¯ ì •í™•í•´ìš”! ìµœê³ !',
                                    'ğŸš€ ë©‹ì ¸ìš”! ê³„ì†!',
                                    'ğŸ‘ ë¸Œë¼ë³´! í›Œë¥­í•´ìš”!',
                                    'ğŸ† ì±”í”¼ì–¸! ë©‹ì§€ë‹¤!',
                                    'âœ¨ ë°˜ì§ë°˜ì§ ì •ë‹µ!',
                                    'ğŸ’ª ì—­ì‹œ ì‹¤ë ¥ì!',
                                    'ğŸŒŸ ìŠ¤íƒ€ íƒ„ìƒ!',
                                    'ğŸ˜ ì¿¨í•˜ê²Œ ì •ë‹µ!',
                                    'ğŸ¯ ëª…ì¤‘! ì™„ë²½!',
                                    'ğŸ‘ êµ¿! ì˜í–ˆì–´ìš”!',
                                    'ğŸ’ ë³´ì„ ê°™ì€ ì‹¤ë ¥!',
                                    'ğŸ¦¸ ì˜ë‹¨ì–´ íˆì–´ë¡œ!'
                                ];
                                const praise = praises[Math.floor(Math.random() * praises.length)];
                                showFeedback(praise + '\n+100ì ', '#4caf50');
                            }
                            
                            setTimeout(() => nextQuestion(), 1000);
                        } else if (enemy.type === 'main') {
                            // ì˜¤ë‹µ!
                            createExplosion(enemy.x + enemy.width/2, enemy.y + enemy.height/2, '#ff4444');
                            game.wrongCount++;
                            game.streak = 0;  // ì—°ì† ì •ë‹µ ë¦¬ì…‹
                            game.wrongWords.push(game.currentWord);
                            game.questionAnswered = true;
                            playSound(200, 0.2, 'sawtooth');
                            
                            updateHeartsDisplay();
                            
                            // 5ë²ˆ í‹€ë¦¬ë©´ ê²Œì„ ì˜¤ë²„
                            if (game.wrongCount >= game.maxWrong) {
                                showFeedback('ğŸ’” ê¸°íšŒë¥¼ ëª¨ë‘ ìƒì—ˆì–´ìš”!', '#f44336');
                                setTimeout(() => gameOver(), 1500);
                            } else {
                                showFeedback(`âŒ ì˜¤ë‹µ!\nì •ë‹µ: ${game.currentWord.word}\në‚¨ì€ ê¸°íšŒ: ${game.maxWrong - game.wrongCount}`, '#f44336');
                                setTimeout(() => nextQuestion(), 1500);
                            }
                        }
                    }
                });
            });
            
            // ëª¨ë“  ë‹¨ì–´ê°€ í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°”ì„ ë•Œ (ì‹œê°„ ì´ˆê³¼)
            if (mainEnemyCount > 0 && allMainEnemiesGone && !game.questionAnswered) {
                game.questionAnswered = true;
                game.wrongCount++;
                game.streak = 0;  // ì—°ì† ì •ë‹µ ë¦¬ì…‹
                game.wrongWords.push(game.currentWord);
                
                updateHeartsDisplay();
                
                if (game.wrongCount >= game.maxWrong) {
                    showFeedback('ğŸ’” ê¸°íšŒë¥¼ ëª¨ë‘ ìƒì—ˆì–´ìš”!', '#f44336');
                    setTimeout(() => gameOver(), 1500);
                } else {
                    showFeedback(`â° ì‹œê°„ ì´ˆê³¼!\nì •ë‹µ: ${game.currentWord.word}\në‚¨ì€ ê¸°íšŒ: ${game.maxWrong - game.wrongCount}`, '#ff9800');
                    playSound(150, 0.3, 'sawtooth');
                    setTimeout(() => nextQuestion(), 1500);
                }
            }
            
            // íŒŒí‹°í´ ì—…ë°ì´íŠ¸
            game.particles = game.particles.filter(p => {
                p.x += p.vx;
                p.y += p.vy;
                p.vy += 0.15;
                p.life--;
                return p.life > 0;
            });
            
            // í’ì„ í­ì£½ ì—…ë°ì´íŠ¸
            game.confetti = game.confetti.filter(c => {
                c.x += c.vx;
                c.y += c.vy;
                c.vy += 0.1;  // ì¤‘ë ¥
                c.rotation += c.rotationSpeed;
                c.life--;
                return c.life > 0;
            });
            
            // ì  ì œê±°
            game.enemies = game.enemies.filter(e => !e.destroyed && e.y < game.height + 100);
        }

        // ì›í˜•(ëŒ€í¬ì•Œ)ê³¼ ì‚¬ê°í˜•(ì ) ì¶©ëŒ ì²´í¬
        function checkCollision(bullet, enemy) {
            // ëŒ€í¬ì•Œ ì¤‘ì‹¬ì 
            const circleX = bullet.x;
            const circleY = bullet.y;
            const radius = bullet.radius || 12;
            
            // ì‚¬ê°í˜•ì—ì„œ ì›ì— ê°€ì¥ ê°€ê¹Œìš´ ì  ì°¾ê¸°
            const closestX = Math.max(enemy.x, Math.min(circleX, enemy.x + enemy.width));
            const closestY = Math.max(enemy.y, Math.min(circleY, enemy.y + enemy.height));
            
            // ê°€ì¥ ê°€ê¹Œìš´ ì ê³¼ ì› ì¤‘ì‹¬ ì‚¬ì´ì˜ ê±°ë¦¬
            const distanceX = circleX - closestX;
            const distanceY = circleY - closestY;
            const distance = Math.sqrt(distanceX * distanceX + distanceY * distanceY);
            
            return distance < radius;
        }

        function createExplosion(x, y, color) {
            for (let i = 0; i < 20; i++) {
                game.particles.push({
                    x: x,
                    y: y,
                    vx: (Math.random() - 0.5) * 8,
                    vy: (Math.random() - 0.5) * 8,
                    color: color,
                    life: 30 + Math.random() * 20
                });
            }
        }

        // í’ì„ í­ì£½ ìƒì„±
        function createConfetti() {
            const colors = [
                '#ff6b6b', '#feca57', '#48dbfb', '#ff9ff3', '#54a0ff',
                '#5f27cd', '#00d2d3', '#ff9f43', '#ee5a24', '#1dd1a1',
                '#ffd700', '#ff6b9d', '#c44569', '#f8b500', '#7bed9f'
            ];
            
            // í™”ë©´ ì—¬ëŸ¬ ìœ„ì¹˜ì—ì„œ í­ì£½ ë°œì‚¬
            const launchPoints = [
                { x: game.width * 0.2, y: game.height },
                { x: game.width * 0.5, y: game.height },
                { x: game.width * 0.8, y: game.height }
            ];
            
            launchPoints.forEach(point => {
                for (let i = 0; i < 30; i++) {
                    const color = colors[Math.floor(Math.random() * colors.length)];
                    const shape = Math.random() > 0.5 ? 'rect' : 'circle';
                    
                    game.confetti.push({
                        x: point.x + (Math.random() - 0.5) * 50,
                        y: point.y,
                        vx: (Math.random() - 0.5) * 8,
                        vy: -8 - Math.random() * 10,  // ìœ„ë¡œ ë°œì‚¬
                        color: color,
                        size: 5 + Math.random() * 8,
                        shape: shape,
                        rotation: Math.random() * 360,
                        rotationSpeed: (Math.random() - 0.5) * 15,
                        life: 80 + Math.random() * 40
                    });
                }
            });
        }

        // ========================================
        // ë Œë”ë§
        // ========================================
        function render() {
            const ctx = game.ctx;
            
            // ë°°ê²½
            ctx.fillStyle = '#0a0a15';
            ctx.fillRect(0, 0, game.width, game.height);
            
            // ë³„
            drawStars();
            
            // ì  (ë‹¨ì–´ ë¸”ë¡)
            game.enemies.forEach(enemy => {
                if (enemy.destroyed) return;
                
                ctx.save();
                ctx.shadowColor = enemy.glowColor;
                ctx.shadowBlur = 15;
                ctx.fillStyle = enemy.color;
                
                const r = 10;
                ctx.beginPath();
                ctx.moveTo(enemy.x + r, enemy.y);
                ctx.lineTo(enemy.x + enemy.width - r, enemy.y);
                ctx.quadraticCurveTo(enemy.x + enemy.width, enemy.y, enemy.x + enemy.width, enemy.y + r);
                ctx.lineTo(enemy.x + enemy.width, enemy.y + enemy.height - r);
                ctx.quadraticCurveTo(enemy.x + enemy.width, enemy.y + enemy.height, enemy.x + enemy.width - r, enemy.y + enemy.height);
                ctx.lineTo(enemy.x + r, enemy.y + enemy.height);
                ctx.quadraticCurveTo(enemy.x, enemy.y + enemy.height, enemy.x, enemy.y + enemy.height - r);
                ctx.lineTo(enemy.x, enemy.y + r);
                ctx.quadraticCurveTo(enemy.x, enemy.y, enemy.x + r, enemy.y);
                ctx.closePath();
                ctx.fill();
                
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                ctx.shadowBlur = 0;
                ctx.fillStyle = '#fff';
                
                // ë°˜ì‘í˜• ê¸€ì”¨ í¬ê¸°
                const fontSize = Math.max(16, Math.floor(22 * game.scaleFactor));
                ctx.font = `bold ${fontSize}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(enemy.text, enemy.x + enemy.width/2, enemy.y + enemy.height/2);
                ctx.restore();
            });
            
            // ëŒ€í¬ì•Œ
            game.bullets.forEach(bullet => {
                ctx.save();
                
                // ëŒ€í¬ì•Œ ê·¸ë¦¼ì/ë°œê´‘ íš¨ê³¼
                ctx.shadowColor = '#ff6600';
                ctx.shadowBlur = 20;
                
                // ì™¸ê³½ ë°œê´‘
                const gradient = ctx.createRadialGradient(
                    bullet.x, bullet.y, 0,
                    bullet.x, bullet.y, bullet.radius
                );
                gradient.addColorStop(0, '#ffffff');
                gradient.addColorStop(0.3, '#ffcc00');
                gradient.addColorStop(0.6, '#ff6600');
                gradient.addColorStop(1, '#cc3300');
                
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(bullet.x, bullet.y, bullet.radius, 0, Math.PI * 2);
                ctx.fill();
                
                // í•˜ì´ë¼ì´íŠ¸
                ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
                ctx.beginPath();
                ctx.arc(bullet.x - 3, bullet.y - 3, bullet.radius * 0.3, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.restore();
            });
            
            // ìš°ì£¼ì„ 
            drawShip();
            
            // íŒŒí‹°í´
            game.particles.forEach(p => {
                ctx.fillStyle = p.color;
                ctx.globalAlpha = p.life / 50;
                ctx.fillRect(p.x - 3, p.y - 3, 6, 6);
            });
            ctx.globalAlpha = 1;
            
            // í’ì„ í­ì£½ (confetti)
            game.confetti.forEach(c => {
                ctx.save();
                ctx.globalAlpha = Math.min(1, c.life / 30);
                ctx.fillStyle = c.color;
                ctx.translate(c.x, c.y);
                ctx.rotate(c.rotation * Math.PI / 180);
                
                if (c.shape === 'rect') {
                    ctx.fillRect(-c.size/2, -c.size/4, c.size, c.size/2);
                } else {
                    ctx.beginPath();
                    ctx.arc(0, 0, c.size/2, 0, Math.PI * 2);
                    ctx.fill();
                }
                
                ctx.restore();
            });
            ctx.globalAlpha = 1;
        }

        function drawStars() {
            const ctx = game.ctx;
            const time = Date.now() / 1000;
            
            for (let i = 0; i < 50; i++) {
                const x = (i * 137.5) % game.width;
                const y = ((i * 73.3 + time * 20) % game.height);
                const brightness = 0.3 + Math.sin(time * 2 + i) * 0.2;
                ctx.fillStyle = `rgba(255, 255, 255, ${brightness})`;
                ctx.fillRect(x, y, 2, 2);
            }
        }

        function drawShip() {
            const ctx = game.ctx;
            const x = game.ship.x;
            const y = game.ship.y;
            const w = game.ship.width;
            const h = game.ship.height;
            
            ctx.save();
            ctx.shadowColor = '#00ffff';
            ctx.shadowBlur = 20;
            
            // ë³¸ì²´
            ctx.fillStyle = '#ffffff';
            ctx.beginPath();
            ctx.moveTo(x + w/2, y);
            ctx.lineTo(x + w, y + h);
            ctx.lineTo(x + w/2, y + h - 10);
            ctx.lineTo(x, y + h);
            ctx.closePath();
            ctx.fill();
            
            // ì¡°ì¢…ì„
            ctx.fillStyle = '#ff0000';
            ctx.beginPath();
            ctx.arc(x + w/2, y + h/2, 5, 0, Math.PI * 2);
            ctx.fill();
            
            // ì—”ì§„
            ctx.fillStyle = '#00ffff';
            const flicker = Math.sin(Date.now() / 50) * 3;
            ctx.fillRect(x + w/2 - 3, y + h - 5 + flicker, 6, 8 + flicker);
            
            ctx.restore();
        }

        // ========================================
        // ë¯¸ì…˜ ì„±ê³µ
        // ========================================
        function missionSuccess() {
            game.running = false;
            cancelAnimationFrame(game.animFrame);
            
            // ë ˆë²¨ ì ìˆ˜ë¥¼ ëˆ„ì  ì ìˆ˜ì— ì¶”ê°€
            player.totalScore += game.score;
            player.passedLevels.push(player.currentLevel);
            
            // Firebaseì— ì ìˆ˜ ì €ì¥
            saveScore();
            
            // ê²°ê³¼ í™”ë©´ í‘œì‹œ
            document.getElementById('resultIcon').textContent = 'ğŸ‰';
            document.getElementById('resultTitle').textContent = 'ğŸ† ë¯¸ì…˜ ì„±ê³µ!';
            document.getElementById('resultTitle').className = 'result-title success';
            document.getElementById('resultLevelScore').textContent = game.score;
            document.getElementById('resultCorrect').textContent = game.correctCount;
            document.getElementById('resultWrong').textContent = game.wrongCount;
            document.getElementById('resultTotalScore').textContent = player.totalScore;
            
            // í‹€ë¦° ë‹¨ì–´ í‘œì‹œ
            const wrongSection = document.getElementById('wrongWordsSection');
            if (game.wrongWords.length > 0) {
                wrongSection.style.display = 'block';
                document.getElementById('wrongWordsList').innerHTML = game.wrongWords.map(w => `
                    <div class="wrong-word-item">
                        <span class="word">${w.word}</span>
                        <span class="meaning">${w.meaning}</span>
                    </div>
                `).join('');
            } else {
                wrongSection.style.display = 'none';
            }
            
            // ë²„íŠ¼ êµ¬ì„±
            const nextLevel = getNextLevel(player.currentLevel);
            let buttonsHtml = '';
            
            if (nextLevel) {
                buttonsHtml += `<button class="btn btn-success" onclick="continueToNextLevel(${nextLevel})">ğŸš€ ë‹¤ìŒ ë ˆë²¨ (${nextLevel}ì ) ë„ì „!</button>`;
            } else {
                buttonsHtml += `<button class="btn btn-success" disabled>ğŸŠ ëª¨ë“  ë ˆë²¨ ì™„ë£Œ!</button>`;
            }
            
            buttonsHtml += `
                <button class="btn btn-primary" onclick="restartLevel()">ğŸ”„ ì´ ë ˆë²¨ ë‹¤ì‹œí•˜ê¸°</button>
                <button class="btn btn-secondary" onclick="showScreen('levelScreen')">ğŸ“š ë ˆë²¨ ì„ íƒ</button>
                <button class="btn btn-warning" onclick="showScreen('leaderboardScreen')">ğŸ† ìˆœìœ„ ë³´ê¸°</button>
            `;
            
            document.getElementById('resultButtons').innerHTML = buttonsHtml;
            
            showScreen('resultScreen');
        }

        function getNextLevel(currentLevel) {
            const levels = [300, 400, 500, 600, 700, 800, 900, 1000];
            const currentIndex = levels.indexOf(currentLevel);
            if (currentIndex < levels.length - 1) {
                return levels[currentIndex + 1];
            }
            return null;
        }

        function continueToNextLevel(level) {
            player.currentLevel = level;
            startGame();
        }

        function restartLevel() {
            startGame();
        }

        // ========================================
        // ê²Œì„ ì˜¤ë²„
        // ========================================
        function gameOver() {
            game.running = false;
            cancelAnimationFrame(game.animFrame);
            
            // ê²Œì„ ì˜¤ë²„ ì‹œì—ëŠ” í˜„ì¬ ë ˆë²¨ ì ìˆ˜ë¥¼ ëˆ„ì í•˜ì§€ ì•ŠìŒ
            // (ë‹¤ì‹œ ë„ì „í•´ì•¼ í•¨)
            
            // ê²°ê³¼ í™”ë©´ í‘œì‹œ
            document.getElementById('resultIcon').textContent = 'ğŸ’”';
            document.getElementById('resultTitle').textContent = 'ê²Œì„ ì˜¤ë²„';
            document.getElementById('resultTitle').className = 'result-title fail';
            document.getElementById('resultLevelScore').textContent = game.score;
            document.getElementById('resultCorrect').textContent = game.correctCount;
            document.getElementById('resultWrong').textContent = game.wrongCount;
            document.getElementById('resultTotalScore').textContent = player.totalScore;
            
            // í‹€ë¦° ë‹¨ì–´ í‘œì‹œ (ìµœëŒ€ 5ê°œ)
            const wrongSection = document.getElementById('wrongWordsSection');
            if (game.wrongWords.length > 0) {
                wrongSection.style.display = 'block';
                document.getElementById('wrongWordsList').innerHTML = game.wrongWords.map(w => `
                    <div class="wrong-word-item">
                        <span class="word">${w.word}</span>
                        <span class="meaning">${w.meaning}</span>
                    </div>
                `).join('');
            } else {
                wrongSection.style.display = 'none';
            }
            
            // ë²„íŠ¼ êµ¬ì„±
            document.getElementById('resultButtons').innerHTML = `
                <button class="btn btn-primary" onclick="restartLevel()">ğŸ”„ ë‹¤ì‹œ ë„ì „í•˜ê¸°</button>
                <button class="btn btn-secondary" onclick="showScreen('levelScreen')">ğŸ“š ë ˆë²¨ ì„ íƒ</button>
                <button class="btn btn-warning" onclick="showScreen('leaderboardScreen')">ğŸ† ìˆœìœ„ ë³´ê¸°</button>
            `;
            
            showScreen('resultScreen');
        }

        // ========================================
        // ì ìˆ˜ ì €ì¥
        // ========================================
        function saveScore() {
            const scoreData = {
                studentId: player.studentId,
                playerName: player.name,
                totalScore: player.totalScore,          // ëˆ„ì  ì´ì 
                levelScore: game.score,                 // í˜„ì¬ ë ˆë²¨ ì ìˆ˜
                level: player.currentLevel,
                passedLevels: player.passedLevels,
                correct: game.correctCount,
                wrong: game.wrongCount,
                total: game.totalQuestions,
                timestamp: Date.now(),
                date: new Date().toISOString()
            };
            
            // ê°™ì€ í•™ë²ˆì˜ ê¸°ì¡´ ìµœê³  ê¸°ë¡ í™•ì¸ í›„ ì—…ë°ì´íŠ¸
            database.ref('toeic_galaga/scores')
                .orderByChild('studentId')
                .equalTo(player.studentId)
                .once('value')
                .then(snapshot => {
                    let shouldSave = true;
                    let existingKey = null;
                    let existingScore = 0;
                    
                    snapshot.forEach(child => {
                        const data = child.val();
                        if (data.totalScore >= player.totalScore) {
                            shouldSave = false;
                        } else {
                            existingKey = child.key;
                            existingScore = data.totalScore;
                        }
                    });
                    
                    if (shouldSave) {
                        if (existingKey) {
                            // ê¸°ì¡´ ê¸°ë¡ ì—…ë°ì´íŠ¸
                            database.ref(`toeic_galaga/scores/${existingKey}`).update(scoreData);
                        } else {
                            // ìƒˆ ê¸°ë¡ ì¶”ê°€
                            database.ref('toeic_galaga/scores').push(scoreData);
                        }
                    }
                });
        }

        // ========================================
        // ìˆœìœ„í‘œ
        // ========================================
        function loadLeaderboard() {
            database.ref('toeic_galaga/scores')
                .orderByChild('totalScore')
                .limitToLast(50)
                .once('value')
                .then(snapshot => {
                    const scores = [];
                    snapshot.forEach(child => {
                        scores.push(child.val());
                    });
                    
                    // ì´ì  ê¸°ì¤€ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
                    scores.sort((a, b) => b.totalScore - a.totalScore);
                    
                    // ê°™ì€ í•™ë²ˆì€ ìµœê³  ì ìˆ˜ë§Œ í‘œì‹œ
                    const uniqueScores = [];
                    const seenIds = new Set();
                    scores.forEach(s => {
                        if (!seenIds.has(s.studentId)) {
                            seenIds.add(s.studentId);
                            uniqueScores.push(s);
                        }
                    });
                    
                    renderLeaderboard(uniqueScores);
                });
        }

        function renderLeaderboard(scores) {
            const container = document.getElementById('leaderboardList');
            
            if (scores.length === 0) {
                container.innerHTML = '<p style="text-align:center; opacity:0.5; padding:20px;">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</p>';
                return;
            }
            
            const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
            
            container.innerHTML = scores.slice(0, 30).map((s, i) => `
                <div class="lb-item">
                    <div class="lb-rank">${i < 3 ? medals[i] : (i + 1)}</div>
                    <div class="lb-info">
                        <div class="lb-name">${s.playerName}</div>
                        <div class="lb-detail">${s.studentId} | ìµœê³  ë ˆë²¨: ${s.level}ì </div>
                    </div>
                    <div class="lb-score">${s.totalScore}</div>
                </div>
            `).join('');
        }

        function goBackFromLeaderboard() {
            if (player.name) {
                showScreen('levelScreen');
            } else {
                showScreen('loginScreen');
            }
        }

        // ========================================
        // ì»¨íŠ¸ë¡¤ ì„¤ì •
        // ========================================
        function setupControls() {
            // í‚¤ë³´ë“œ
            document.onkeydown = (e) => {
                game.keys[e.code] = true;
                if (e.code === 'Space') {
                    e.preventDefault();
                    shoot();
                }
            };
            document.onkeyup = (e) => {
                game.keys[e.code] = false;
            };
            
            // ëª¨ë°”ì¼ ë²„íŠ¼
            const leftBtn = document.getElementById('leftBtn');
            const rightBtn = document.getElementById('rightBtn');
            const fireBtn = document.getElementById('fireBtn');
            
            leftBtn.ontouchstart = (e) => { e.preventDefault(); game.keys['ArrowLeft'] = true; };
            leftBtn.ontouchend = () => game.keys['ArrowLeft'] = false;
            rightBtn.ontouchstart = (e) => { e.preventDefault(); game.keys['ArrowRight'] = true; };
            rightBtn.ontouchend = () => game.keys['ArrowRight'] = false;
            fireBtn.ontouchstart = (e) => { e.preventDefault(); shoot(); };
            
            // ìº”ë²„ìŠ¤ í„°ì¹˜
            const canvas = game.canvas;
            canvas.ontouchstart = (e) => {
                e.preventDefault();
                game.touchX = e.touches[0].clientX;
            };
            canvas.ontouchmove = (e) => {
                e.preventDefault();
                game.touchX = e.touches[0].clientX;
            };
            canvas.ontouchend = () => {
                game.touchX = null;
            };
            
            canvas.onclick = () => shoot();
        }

        // ========================================
        // ì‚¬ìš´ë“œ
        // ========================================
        function playSound(freq, duration, type) {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                
                oscillator.frequency.value = freq;
                oscillator.type = type;
                gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
                
                oscillator.start(audioCtx.currentTime);
                oscillator.stop(audioCtx.currentTime + duration);
            } catch (e) {}
        }

        // ========================================
        // ìœˆë„ìš° ë¦¬ì‚¬ì´ì¦ˆ
        // ========================================
        window.onresize = () => {
            if (game.canvas) {
                resizeCanvas();
                if (game.ship) {
                    game.ship.y = game.height - game.ship.height - 20;
                }
            }
        };
    </script>
</body>
</html>
