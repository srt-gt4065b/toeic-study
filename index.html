<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸš€ í† ìµ ì˜ë‹¨ì–´ ê°¤ëŸ¬ê·¸</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            touch-action: none;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a15 0%, #1a1a2e 50%, #0a0a15 100%);
            color: white;
        }

        /* ===== ê³µí†µ ìŠ¤íƒ€ì¼ ===== */
        .screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow-y: auto;
        }

        .screen.active {
            display: flex;
        }

        .card {
            background: rgba(26, 26, 46, 0.95);
            border: 2px solid #667eea;
            border-radius: 20px;
            padding: 30px;
            max-width: 450px;
            width: 100%;
            backdrop-filter: blur(10px);
        }

        .title {
            font-size: clamp(24px, 6vw, 36px);
            text-align: center;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2, #f093fb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            text-align: center;
            opacity: 0.7;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            opacity: 0.9;
        }

        .input-group input, .input-group select, .input-group textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #667eea;
            border-radius: 12px;
            background: rgba(0,0,0,0.3);
            color: white;
            font-size: 16px;
            outline: none;
            transition: all 0.3s;
        }

        .input-group input:focus, .input-group select:focus {
            border-color: #f093fb;
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.5);
        }

        .input-group select option {
            background: #1a1a2e;
            color: white;
        }

        .btn {
            width: 100%;
            padding: 15px 30px;
            margin: 8px 0;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
        }

        .btn:hover, .btn:active {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); }
        .btn-success { background: linear-gradient(135deg, #4caf50, #8bc34a); }
        .btn-warning { background: linear-gradient(135deg, #ff9800, #ffb74d); }
        .btn-danger { background: linear-gradient(135deg, #f44336, #ff5722); }
        .btn-secondary { background: linear-gradient(135deg, #455a64, #78909c); }
        .btn-small { padding: 10px 20px; font-size: 14px; width: auto; }

        /* ===== ë¡œê·¸ì¸ í™”ë©´ ===== */
        #loginScreen .logo {
            font-size: 60px;
            text-align: center;
            margin-bottom: 20px;
        }

        .admin-link {
            text-align: center;
            margin-top: 20px;
            font-size: 12px;
            opacity: 0.6;
        }

        .admin-link a {
            color: #667eea;
            text-decoration: none;
        }

        /* ===== ë ˆë²¨ ì„ íƒ í™”ë©´ ===== */
        .level-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .level-btn {
            padding: 20px 15px;
            border: 2px solid #667eea;
            border-radius: 15px;
            background: rgba(102, 126, 234, 0.1);
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .level-btn:hover, .level-btn.selected {
            background: rgba(102, 126, 234, 0.4);
            border-color: #f093fb;
            transform: scale(1.02);
        }

        .level-btn .score {
            font-size: 24px;
            font-weight: bold;
            color: #ffd700;
        }

        .level-btn .label {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 5px;
        }

        .player-info {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
        }

        .player-info .name {
            font-size: 18px;
            font-weight: bold;
            color: #00ff88;
        }

        /* ===== ê²Œì„ ì»¨í…Œì´ë„ˆ ===== */
        #gameScreen {
            padding: 0;
            justify-content: flex-start;
        }

        #gameContainer {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        #topUI {
            flex-shrink: 0;
            background: linear-gradient(180deg, rgba(10,10,21,0.98) 0%, rgba(10,10,21,0.9) 100%);
            padding: 10px 15px;
            border-bottom: 2px solid #667eea;
            z-index: 100;
        }

        .stats-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .stat-box {
            flex: 1;
            background: rgba(102, 126, 234, 0.2);
            padding: 8px 12px;
            border-radius: 10px;
            border: 1px solid rgba(102, 126, 234, 0.5);
            text-align: center;
        }

        .stat-label { font-size: 11px; opacity: 0.7; margin-bottom: 2px; }
        .stat-value { font-size: 18px; font-weight: bold; }
        .stat-value.score { color: #ffd700; }
        .stat-value.time { color: #00ff88; }

        .word-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 12px 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
        }

        .word-label { font-size: 11px; opacity: 0.8; margin-bottom: 3px; }
        .word-korean { font-size: 24px; font-weight: bold; }
        .word-hint { font-size: 14px; color: #ffd700; margin-top: 3px; }

        #canvasWrapper {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: radial-gradient(ellipse at center, #1a1a2e 0%, #0a0a15 100%);
        }

        #gameCanvas { display: block; width: 100%; height: 100%; }

        .feedback {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 28px;
            font-weight: bold;
            padding: 15px 30px;
            border-radius: 15px;
            opacity: 0;
            pointer-events: none;
            z-index: 50;
            text-align: center;
        }

        .feedback.show {
            opacity: 1;
            animation: feedbackPop 0.5s ease-out;
        }

        @keyframes feedbackPop {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        #mobileControls {
            flex-shrink: 0;
            background: linear-gradient(0deg, rgba(10,10,21,0.98) 0%, rgba(10,10,21,0.9) 100%);
            padding: 15px;
            border-top: 2px solid #667eea;
            display: none;
        }

        .control-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 400px;
            margin: 0 auto;
        }

        .move-buttons { display: flex; gap: 15px; }

        .ctrl-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 3px solid rgba(102, 126, 234, 0.8);
            background: rgba(102, 126, 234, 0.3);
            color: white;
            font-size: 28px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            -webkit-user-select: none;
            user-select: none;
        }

        .ctrl-btn:active { background: rgba(102, 126, 234, 0.7); transform: scale(0.95); }

        .fire-btn {
            width: 85px;
            height: 85px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            border: 3px solid #fff;
            font-size: 14px;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            #mobileControls { display: block; }
        }

        /* ===== ê²°ê³¼ í™”ë©´ ===== */
        #resultScreen .card {
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .result-score {
            font-size: 56px;
            font-weight: bold;
            color: #ffd700;
            text-align: center;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            margin: 20px 0;
        }

        .result-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .result-stat {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .result-stat .value {
            font-size: 24px;
            font-weight: bold;
            color: #00ff88;
        }

        .result-stat .label {
            font-size: 12px;
            opacity: 0.7;
        }

        .wrong-words-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.2);
        }

        .wrong-words-title {
            font-size: 16px;
            color: #ff6b6b;
            margin-bottom: 15px;
            text-align: center;
        }

        .wrong-word-item {
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid rgba(255, 107, 107, 0.3);
            border-radius: 10px;
            padding: 12px 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .wrong-word-item .word {
            font-weight: bold;
            color: #ffd700;
        }

        .wrong-word-item .meaning {
            color: #00ff88;
        }

        /* ===== ë¦¬ë”ë³´ë“œ í™”ë©´ ===== */
        #leaderboardScreen .card {
            max-width: 600px;
            max-height: 85vh;
        }

        .leaderboard-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
        }

        .tab-btn {
            padding: 10px 20px;
            border: 2px solid #667eea;
            border-radius: 10px;
            background: transparent;
            color: white;
            cursor: pointer;
            white-space: nowrap;
            font-size: 14px;
        }

        .tab-btn.active {
            background: #667eea;
        }

        .leaderboard-table {
            max-height: 400px;
            overflow-y: auto;
        }

        .lb-row {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .lb-row:nth-child(1) { background: rgba(255, 215, 0, 0.1); }
        .lb-row:nth-child(2) { background: rgba(192, 192, 192, 0.1); }
        .lb-row:nth-child(3) { background: rgba(205, 127, 50, 0.1); }

        .lb-rank { width: 40px; font-weight: bold; font-size: 18px; }
        .lb-name { flex: 1; }
        .lb-score { width: 80px; text-align: right; color: #ffd700; font-weight: bold; }
        .lb-level { width: 60px; text-align: center; font-size: 12px; opacity: 0.7; }

        /* ===== ê´€ë¦¬ì í™”ë©´ ===== */
        #adminScreen .card {
            max-width: 600px;
        }

        .csv-upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .csv-upload-area:hover {
            border-color: #f093fb;
            background: rgba(102, 126, 234, 0.1);
        }

        .csv-upload-area input[type="file"] {
            display: none;
        }

        .csv-preview {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 20px;
            font-family: monospace;
            font-size: 13px;
        }

        .csv-format {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 13px;
        }

        .csv-format code {
            color: #00ff88;
        }

        .word-count-display {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .word-count-item {
            background: rgba(102, 126, 234, 0.2);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }

        .word-count-item .count {
            font-size: 20px;
            font-weight: bold;
            color: #ffd700;
        }

        .word-count-item .level {
            font-size: 11px;
            opacity: 0.7;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-overlay.show {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.2);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ìŠ¤í¬ë¡¤ë°” */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #667eea; border-radius: 4px; }
    </style>
</head>
<body>
    <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <!-- 1. ë¡œê·¸ì¸ í™”ë©´ -->
    <div class="screen active" id="loginScreen">
        <div class="card">
            <div class="logo">ğŸš€</div>
            <h1 class="title">í† ìµ ì˜ë‹¨ì–´ ê°¤ëŸ¬ê·¸</h1>
            <p class="subtitle">ì˜ì–´ ì‹¤ë ¥ì„ ê²Œì„ìœ¼ë¡œ í‚¤ì›Œë³´ì„¸ìš”!</p>
            
            <div class="input-group">
                <label>í•™ë²ˆ</label>
                <input type="text" id="studentId" placeholder="ì˜ˆ: 20241234" maxlength="20">
            </div>
            
            <div class="input-group">
                <label>ì´ë¦„</label>
                <input type="text" id="playerName" placeholder="ì˜ˆ: í™ê¸¸ë™" maxlength="20">
            </div>
            
            <button class="btn btn-primary" onclick="login()">ğŸ® ì‹œì‘í•˜ê¸°</button>
            <button class="btn btn-secondary" onclick="showLeaderboard()">ğŸ† ìˆœìœ„ ë³´ê¸°</button>
            
            <div class="admin-link">
                <a href="#" onclick="showAdminLogin()">ê´€ë¦¬ì ëª¨ë“œ</a>
            </div>
        </div>
    </div>

    <!-- 2. ë ˆë²¨ ì„ íƒ í™”ë©´ -->
    <div class="screen" id="levelScreen">
        <div class="card">
            <h1 class="title">ë ˆë²¨ ì„ íƒ</h1>
            
            <div class="player-info">
                <span class="name" id="displayName">-</span>
                <span style="opacity:0.6" id="displayId">(-)</span>
            </div>
            
            <p class="subtitle">ëª©í‘œ í† ìµ ì ìˆ˜ë¥¼ ì„ íƒí•˜ì„¸ìš”</p>
            
            <div class="level-grid">
                <div class="level-btn" data-level="300" onclick="selectLevel(300)">
                    <div class="score">300</div>
                    <div class="label">ì…ë¬¸</div>
                </div>
                <div class="level-btn" data-level="400" onclick="selectLevel(400)">
                    <div class="score">400</div>
                    <div class="label">ê¸°ì´ˆ</div>
                </div>
                <div class="level-btn" data-level="500" onclick="selectLevel(500)">
                    <div class="score">500</div>
                    <div class="label">ì´ˆê¸‰</div>
                </div>
                <div class="level-btn" data-level="600" onclick="selectLevel(600)">
                    <div class="score">600</div>
                    <div class="label">ì¤‘ê¸‰</div>
                </div>
                <div class="level-btn" data-level="700" onclick="selectLevel(700)">
                    <div class="score">700</div>
                    <div class="label">ì¤‘ìƒê¸‰</div>
                </div>
                <div class="level-btn" data-level="800" onclick="selectLevel(800)">
                    <div class="score">800</div>
                    <div class="label">ìƒê¸‰</div>
                </div>
                <div class="level-btn" data-level="900" onclick="selectLevel(900)">
                    <div class="score">900</div>
                    <div class="label">ê³ ê¸‰</div>
                </div>
                <div class="level-btn" data-level="1000" onclick="selectLevel(1000)">
                    <div class="score">990+</div>
                    <div class="label">ë§Œì </div>
                </div>
            </div>
            
            <button class="btn btn-success" id="startGameBtn" onclick="startGame()" disabled>ê²Œì„ ì‹œì‘</button>
            <button class="btn btn-secondary" onclick="logout()">â† ë’¤ë¡œ</button>
        </div>
    </div>

    <!-- 3. ê²Œì„ í™”ë©´ -->
    <div class="screen" id="gameScreen">
        <div id="gameContainer">
            <div id="topUI">
                <div class="stats-row">
                    <div class="stat-box">
                        <div class="stat-label">ì ìˆ˜</div>
                        <div class="stat-value score" id="score">0</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">ë¬¸ì œ</div>
                        <div class="stat-value" id="questionNum">1/10</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">ë ˆë²¨</div>
                        <div class="stat-value" id="levelDisplay">600</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">ì‹œê°„</div>
                        <div class="stat-value time" id="timeLeft">60</div>
                    </div>
                </div>
                <div class="word-display">
                    <div class="word-label">ì´ ëœ»ì˜ ì˜ì–´ ë‹¨ì–´ëŠ”?</div>
                    <div class="word-korean" id="targetMeaning">ì¤€ë¹„ì¤‘...</div>
                    <div class="word-hint" id="dynamicScore">100ì </div>
                </div>
            </div>
            
            <div id="canvasWrapper">
                <canvas id="gameCanvas"></canvas>
                <div id="feedback" class="feedback"></div>
            </div>
            
            <div id="mobileControls">
                <div class="control-row">
                    <div class="move-buttons">
                        <button class="ctrl-btn" id="btnLeft">â—€</button>
                        <button class="ctrl-btn" id="btnRight">â–¶</button>
                    </div>
                    <button class="ctrl-btn fire-btn" id="btnFire">FIRE</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 4. ê²°ê³¼ í™”ë©´ -->
    <div class="screen" id="resultScreen">
        <div class="card">
            <h1 class="title">ğŸ® ê²Œì„ ì™„ë£Œ!</h1>
            
            <div class="result-score" id="finalScore">0</div>
            
            <div class="result-stats">
                <div class="result-stat">
                    <div class="value" id="resultCorrect">0</div>
                    <div class="label">ì •ë‹µ</div>
                </div>
                <div class="result-stat">
                    <div class="value" id="resultWrong">0</div>
                    <div class="label">ì˜¤ë‹µ</div>
                </div>
                <div class="result-stat">
                    <div class="value" id="resultLevel">600</div>
                    <div class="label">ë ˆë²¨</div>
                </div>
            </div>
            
            <div class="wrong-words-section" id="wrongWordsSection" style="display:none;">
                <div class="wrong-words-title">ğŸ“š í‹€ë¦° ë‹¨ì–´ ë³µìŠµ</div>
                <div id="wrongWordsList"></div>
            </div>
            
            <button class="btn btn-success" onclick="restartGame()">ğŸ”„ ë‹¤ì‹œí•˜ê¸°</button>
            <button class="btn btn-primary" onclick="showLevelSelect()">ğŸ“Š ë ˆë²¨ ì„ íƒ</button>
            <button class="btn btn-warning" onclick="showLeaderboard()">ğŸ† ìˆœìœ„ ë³´ê¸°</button>
            <button class="btn btn-secondary" onclick="logout()">ğŸ  ì²˜ìŒìœ¼ë¡œ</button>
        </div>
    </div>

    <!-- 5. ë¦¬ë”ë³´ë“œ í™”ë©´ -->
    <div class="screen" id="leaderboardScreen">
        <div class="card">
            <h1 class="title">ğŸ† ìˆœìœ„í‘œ</h1>
            
            <div class="leaderboard-tabs" id="leaderboardTabs">
                <button class="tab-btn active" data-level="all" onclick="filterLeaderboard('all')">ì „ì²´</button>
                <button class="tab-btn" data-level="300" onclick="filterLeaderboard(300)">300</button>
                <button class="tab-btn" data-level="400" onclick="filterLeaderboard(400)">400</button>
                <button class="tab-btn" data-level="500" onclick="filterLeaderboard(500)">500</button>
                <button class="tab-btn" data-level="600" onclick="filterLeaderboard(600)">600</button>
                <button class="tab-btn" data-level="700" onclick="filterLeaderboard(700)">700</button>
                <button class="tab-btn" data-level="800" onclick="filterLeaderboard(800)">800</button>
                <button class="tab-btn" data-level="900" onclick="filterLeaderboard(900)">900</button>
                <button class="tab-btn" data-level="1000" onclick="filterLeaderboard(1000)">990+</button>
            </div>
            
            <div class="leaderboard-table" id="leaderboardTable">
                <div style="text-align:center; padding:30px; opacity:0.6;">ë°ì´í„° ë¡œë”© ì¤‘...</div>
            </div>
            
            <button class="btn btn-secondary" onclick="goBack()">â† ë’¤ë¡œ</button>
        </div>
    </div>

    <!-- 6. ê´€ë¦¬ì í™”ë©´ -->
    <div class="screen" id="adminScreen">
        <div class="card">
            <h1 class="title">âš™ï¸ ê´€ë¦¬ì ëª¨ë“œ</h1>
            
            <div class="input-group">
                <label>ë ˆë²¨ ì„ íƒ</label>
                <select id="adminLevelSelect">
                    <option value="300">í† ìµ 300ì  ëª©í‘œ</option>
                    <option value="400">í† ìµ 400ì  ëª©í‘œ</option>
                    <option value="500">í† ìµ 500ì  ëª©í‘œ</option>
                    <option value="600" selected>í† ìµ 600ì  ëª©í‘œ</option>
                    <option value="700">í† ìµ 700ì  ëª©í‘œ</option>
                    <option value="800">í† ìµ 800ì  ëª©í‘œ</option>
                    <option value="900">í† ìµ 900ì  ëª©í‘œ</option>
                    <option value="1000">í† ìµ 990ì + ëª©í‘œ</option>
                </select>
            </div>
            
            <div class="csv-format">
                <strong>CSV í˜•ì‹:</strong><br>
                <code>word,meaning</code><br>
                <code>abundant,í’ë¶€í•œ</code><br>
                <code>acquire,íšë“í•˜ë‹¤</code><br>
                <code>...</code>
            </div>
            
            <div class="csv-upload-area" onclick="document.getElementById('csvFile').click()">
                <div style="font-size:40px; margin-bottom:10px;">ğŸ“„</div>
                <div>CSV íŒŒì¼ì„ í´ë¦­í•˜ì—¬ ì„ íƒ</div>
                <div style="font-size:12px; opacity:0.6; margin-top:5px;">ë˜ëŠ” ì—¬ê¸°ì— ë“œë˜ê·¸</div>
                <input type="file" id="csvFile" accept=".csv" onchange="handleCSV(this)">
            </div>
            
            <div class="csv-preview" id="csvPreview" style="display:none;"></div>
            
            <button class="btn btn-success" id="uploadBtn" onclick="uploadWords()" disabled>ğŸ“¤ ì—…ë¡œë“œ</button>
            
            <div style="margin-top:20px;">
                <div style="font-size:14px; margin-bottom:10px;">í˜„ì¬ ë“±ë¡ëœ ë‹¨ì–´ ìˆ˜:</div>
                <div class="word-count-display" id="wordCountDisplay">
                    <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
                </div>
            </div>
            
            <button class="btn btn-secondary" onclick="showScreen('loginScreen')">â† ë’¤ë¡œ</button>
        </div>
    </div>

    <script>
        // ========================================
        // Firebase ì„¤ì •
        // ========================================
        const firebaseConfig = {
            apiKey: "AIzaSyA6NONPoeAGHcMLkLwPunduIGqmODUQnAQ",
  authDomain: "toeic-voca-30c67.firebaseapp.com",
  databaseURL: "https://toeic-voca-30c67-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "toeic-voca-30c67",
  storageBucket: "toeic-voca-30c67.firebasestorage.app",
  messagingSenderId: "740332360254",
  appId: "1:740332360254:web:c04edc2988a6e6f63f776f",
  measurementId: "G-9E8HXE4LJ7"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // ========================================
        // ê¸°ë³¸ ë‹¨ì–´ ë°ì´í„° (Firebaseì— ë‹¨ì–´ê°€ ì—†ì„ ë•Œ ì‚¬ìš©)
        // ========================================
        const defaultWords = {
            300: [
                { word: 'book', meaning: 'ì±…' }, { word: 'water', meaning: 'ë¬¼' },
                { word: 'food', meaning: 'ìŒì‹' }, { word: 'work', meaning: 'ì¼í•˜ë‹¤' },
                { word: 'time', meaning: 'ì‹œê°„' }, { word: 'money', meaning: 'ëˆ' },
                { word: 'people', meaning: 'ì‚¬ëŒë“¤' }, { word: 'year', meaning: 'ë…„' },
                { word: 'good', meaning: 'ì¢‹ì€' }, { word: 'make', meaning: 'ë§Œë“¤ë‹¤' },
                { word: 'help', meaning: 'ë•ë‹¤' }, { word: 'want', meaning: 'ì›í•˜ë‹¤' },
                { word: 'need', meaning: 'í•„ìš”í•˜ë‹¤' }, { word: 'know', meaning: 'ì•Œë‹¤' },
                { word: 'find', meaning: 'ì°¾ë‹¤' }, { word: 'give', meaning: 'ì£¼ë‹¤' }
            ],
            400: [
                { word: 'available', meaning: 'ì´ìš© ê°€ëŠ¥í•œ' }, { word: 'provide', meaning: 'ì œê³µí•˜ë‹¤' },
                { word: 'include', meaning: 'í¬í•¨í•˜ë‹¤' }, { word: 'require', meaning: 'ìš”êµ¬í•˜ë‹¤' },
                { word: 'complete', meaning: 'ì™„ë£Œí•˜ë‹¤' }, { word: 'receive', meaning: 'ë°›ë‹¤' },
                { word: 'expect', meaning: 'ê¸°ëŒ€í•˜ë‹¤' }, { word: 'consider', meaning: 'ê³ ë ¤í•˜ë‹¤' },
                { word: 'increase', meaning: 'ì¦ê°€í•˜ë‹¤' }, { word: 'reduce', meaning: 'ì¤„ì´ë‹¤' },
                { word: 'improve', meaning: 'ê°œì„ í•˜ë‹¤' }, { word: 'develop', meaning: 'ê°œë°œí•˜ë‹¤' },
                { word: 'support', meaning: 'ì§€ì›í•˜ë‹¤' }, { word: 'maintain', meaning: 'ìœ ì§€í•˜ë‹¤' },
                { word: 'achieve', meaning: 'ë‹¬ì„±í•˜ë‹¤' }, { word: 'produce', meaning: 'ìƒì‚°í•˜ë‹¤' }
            ],
            500: [
                { word: 'announce', meaning: 'ë°œí‘œí•˜ë‹¤' }, { word: 'approximately', meaning: 'ëŒ€ëµ' },
                { word: 'arrange', meaning: 'ì¤€ë¹„í•˜ë‹¤' }, { word: 'assist', meaning: 'ë•ë‹¤' },
                { word: 'attend', meaning: 'ì°¸ì„í•˜ë‹¤' }, { word: 'authorized', meaning: 'í—ˆê°€ëœ' },
                { word: 'budget', meaning: 'ì˜ˆì‚°' }, { word: 'capable', meaning: 'ëŠ¥ë ¥ ìˆëŠ”' },
                { word: 'confirm', meaning: 'í™•ì¸í•˜ë‹¤' }, { word: 'convenient', meaning: 'í¸ë¦¬í•œ' },
                { word: 'currently', meaning: 'í˜„ì¬' }, { word: 'deadline', meaning: 'ë§ˆê°ì¼' },
                { word: 'demonstrate', meaning: 'ë³´ì—¬ì£¼ë‹¤' }, { word: 'department', meaning: 'ë¶€ì„œ' },
                { word: 'effective', meaning: 'íš¨ê³¼ì ì¸' }, { word: 'eligible', meaning: 'ìê²© ìˆëŠ”' }
            ],
            600: [
                { word: 'accomplish', meaning: 'ì„±ì·¨í•˜ë‹¤' }, { word: 'adequate', meaning: 'ì ì ˆí•œ' },
                { word: 'anticipate', meaning: 'ì˜ˆìƒí•˜ë‹¤' }, { word: 'apparent', meaning: 'ë¶„ëª…í•œ' },
                { word: 'attribute', meaning: '~ì˜ íƒ“ìœ¼ë¡œ í•˜ë‹¤' }, { word: 'authorize', meaning: 'ê¶Œí•œì„ ë¶€ì—¬í•˜ë‹¤' },
                { word: 'comprehensive', meaning: 'í¬ê´„ì ì¸' }, { word: 'consistent', meaning: 'ì¼ê´€ëœ' },
                { word: 'considerable', meaning: 'ìƒë‹¹í•œ' }, { word: 'contribute', meaning: 'ê¸°ì—¬í•˜ë‹¤' },
                { word: 'crucial', meaning: 'ì¤‘ìš”í•œ' }, { word: 'deliberate', meaning: 'ì‹ ì¤‘í•œ' },
                { word: 'emphasize', meaning: 'ê°•ì¡°í•˜ë‹¤' }, { word: 'enhance', meaning: 'í–¥ìƒì‹œí‚¤ë‹¤' },
                { word: 'essential', meaning: 'í•„ìˆ˜ì ì¸' }, { word: 'evaluate', meaning: 'í‰ê°€í•˜ë‹¤' }
            ],
            700: [
                { word: 'accommodate', meaning: 'ìˆ˜ìš©í•˜ë‹¤' }, { word: 'acquisition', meaning: 'íšë“' },
                { word: 'adjacent', meaning: 'ì¸ì ‘í•œ' }, { word: 'adversely', meaning: 'ë¶ˆë¦¬í•˜ê²Œ' },
                { word: 'aggregate', meaning: 'í•©ê³„' }, { word: 'allocate', meaning: 'ë°°ë¶„í•˜ë‹¤' },
                { word: 'ambiguous', meaning: 'ëª¨í˜¸í•œ' }, { word: 'benchmark', meaning: 'ê¸°ì¤€ì ' },
                { word: 'compliance', meaning: 'ì¤€ìˆ˜' }, { word: 'consolidate', meaning: 'í†µí•©í•˜ë‹¤' },
                { word: 'contingent', meaning: '~ì— ë‹¬ë ¤ ìˆëŠ”' }, { word: 'deteriorate', meaning: 'ì•…í™”ë˜ë‹¤' },
                { word: 'discrepancy', meaning: 'ë¶ˆì¼ì¹˜' }, { word: 'encompass', meaning: 'í¬í•¨í•˜ë‹¤' },
                { word: 'expedite', meaning: 'ì´‰ì§„í•˜ë‹¤' }, { word: 'feasible', meaning: 'ì‹¤í–‰ ê°€ëŠ¥í•œ' }
            ],
            800: [
                { word: 'alleviate', meaning: 'ì™„í™”í•˜ë‹¤' }, { word: 'amorphous', meaning: 'ë¬´ì •í˜•ì˜' },
                { word: 'articulate', meaning: 'ëª…í™•íˆ í‘œí˜„í•˜ë‹¤' }, { word: 'burgeoning', meaning: 'ê¸‰ì„±ì¥í•˜ëŠ”' },
                { word: 'circumvent', meaning: 'íšŒí”¼í•˜ë‹¤' }, { word: 'cohesive', meaning: 'ì‘ì§‘ë ¥ ìˆëŠ”' },
                { word: 'commensurate', meaning: 'ìƒì‘í•˜ëŠ”' }, { word: 'conglomerate', meaning: 'ëŒ€ê¸°ì—…' },
                { word: 'corroborate', meaning: 'í™•ì¦í•˜ë‹¤' }, { word: 'delineate', meaning: 'ì„œìˆ í•˜ë‹¤' },
                { word: 'disposition', meaning: 'ì„±í–¥' }, { word: 'efficacy', meaning: 'íš¨ëŠ¥' },
                { word: 'exacerbate', meaning: 'ì•…í™”ì‹œí‚¤ë‹¤' }, { word: 'fluctuate', meaning: 'ë³€ë™í•˜ë‹¤' },
                { word: 'fortuitous', meaning: 'ìš°ì—°ì˜' }, { word: 'homogeneous', meaning: 'ë™ì§ˆì˜' }
            ],
            900: [
                { word: 'ameliorate', meaning: 'ê°œì„ í•˜ë‹¤' }, { word: 'ancillary', meaning: 'ë³´ì¡°ì ì¸' },
                { word: 'antipathy', meaning: 'ë°˜ê°' }, { word: 'cogent', meaning: 'ì„¤ë“ë ¥ ìˆëŠ”' },
                { word: 'concomitant', meaning: 'ìˆ˜ë°˜í•˜ëŠ”' }, { word: 'conundrum', meaning: 'ë‚œì œ' },
                { word: 'cursory', meaning: 'í”¼ìƒì ì¸' }, { word: 'dichotomy', meaning: 'ì´ë¶„ë²•' },
                { word: 'disparate', meaning: 'ì´ì§ˆì ì¸' }, { word: 'ephemeral', meaning: 'ì¼ì‹œì ì¸' },
                { word: 'equivocal', meaning: 'ì• ë§¤í•œ' }, { word: 'extraneous', meaning: 'ê´€ë ¨ ì—†ëŠ”' },
                { word: 'facetious', meaning: 'ë†ë‹´í•˜ëŠ”' }, { word: 'gregarious', meaning: 'ì‚¬êµì ì¸' },
                { word: 'hegemony', meaning: 'íŒ¨ê¶Œ' }, { word: 'idiosyncratic', meaning: 'íŠ¹ì´í•œ' }
            ],
            1000: [
                { word: 'abstruse', meaning: 'ë‚œí•´í•œ' }, { word: 'acrimonious', meaning: 'ì‹ ë„í•œ' },
                { word: 'apotheosis', meaning: 'ì‹ ê²©í™”' }, { word: 'auspicious', meaning: 'ìƒì„œë¡œìš´' },
                { word: 'byzantine', meaning: 'ë³µì¡í•œ' }, { word: 'cacophony', meaning: 'ë¶ˆí˜‘í™”ìŒ' },
                { word: 'capricious', meaning: 'ë³€ë•ìŠ¤ëŸ¬ìš´' }, { word: 'deleterious', meaning: 'í•´ë¡œìš´' },
                { word: 'ebullient', meaning: 'ì—´ê´‘ì ì¸' }, { word: 'esoteric', meaning: 'ë‚œí•´í•œ' },
                { word: 'ineffable', meaning: 'ë§ë¡œ í‘œí˜„í•  ìˆ˜ ì—†ëŠ”' }, { word: 'inimical', meaning: 'ì ëŒ€ì ì¸' },
                { word: 'lugubrious', meaning: 'ìŒìš¸í•œ' }, { word: 'magnanimous', meaning: 'ê´€ëŒ€í•œ' },
                { word: 'obsequious', meaning: 'ì•„ì²¨í•˜ëŠ”' }, { word: 'perspicacious', meaning: 'ì˜ˆë¦¬í•œ' }
            ]
        };

        // ========================================
        // ì „ì—­ ìƒíƒœ
        // ========================================
        let currentUser = { studentId: '', playerName: '' };
        let selectedLevel = null;
        let previousScreen = 'loginScreen';
        let allScores = [];
        let csvData = [];

        // ê²Œì„ ìƒíƒœ
        const game = {
            canvas: null,
            ctx: null,
            width: 0,
            height: 0,
            
            words: [],
            currentWord: null,
            questionIndex: 0,
            maxQuestions: 10,
            
            score: 0,
            maxScore: 100,
            correctCount: 0,
            wrongWords: [],
            
            timeLeft: 60,
            lastTime: 0,
            
            ship: { x: 0, y: 0, width: 40, height: 40, speed: 8 },
            bullets: [],
            enemies: [],
            particles: [],
            stars: [],
            
            keys: { left: false, right: false },
            running: false,
            questionAnswered: false
        };

        // ========================================
        // í™”ë©´ ì „í™˜
        // ========================================
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function showLoading(show) {
            document.getElementById('loadingOverlay').classList.toggle('show', show);
        }

        // ========================================
        // ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ
        // ========================================
        function login() {
            const studentId = document.getElementById('studentId').value.trim();
            const playerName = document.getElementById('playerName').value.trim();
            
            if (!studentId || !playerName) {
                alert('í•™ë²ˆê³¼ ì´ë¦„ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            currentUser = { studentId, playerName };
            document.getElementById('displayName').textContent = playerName;
            document.getElementById('displayId').textContent = `(${studentId})`;
            
            previousScreen = 'loginScreen';
            showScreen('levelScreen');
        }

        function logout() {
            currentUser = { studentId: '', playerName: '' };
            selectedLevel = null;
            document.getElementById('studentId').value = '';
            document.getElementById('playerName').value = '';
            showScreen('loginScreen');
        }

        function showAdminLogin() {
            const password = prompt('ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
            if (password === 'admin1234') {
                loadWordCounts();
                previousScreen = 'loginScreen';
                showScreen('adminScreen');
            } else if (password !== null) {
                alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.');
            }
        }

        // ========================================
        // ë ˆë²¨ ì„ íƒ
        // ========================================
        function selectLevel(level) {
            selectedLevel = level;
            document.querySelectorAll('.level-btn').forEach(btn => {
                btn.classList.toggle('selected', btn.dataset.level == level);
            });
            document.getElementById('startGameBtn').disabled = false;
        }

        function showLevelSelect() {
            previousScreen = 'resultScreen';
            showScreen('levelScreen');
        }

        // ========================================
        // ê²Œì„ ì‹œì‘
        // ========================================
        async function startGame() {
            if (!selectedLevel) return;
            
            showLoading(true);
            
            try {
                // Firebaseì—ì„œ ë‹¨ì–´ ë¡œë“œ
                game.words = await loadWordsFromFirebase(selectedLevel);
                
                if (game.words.length < 10) {
                    // ê¸°ë³¸ ë‹¨ì–´ ì‚¬ìš©
                    game.words = [...defaultWords[selectedLevel]];
                }
                
                // ë‹¨ì–´ ì„ê¸°
                game.words = shuffleArray(game.words);
                
                // ê²Œì„ ì´ˆê¸°í™”
                game.questionIndex = 0;
                game.score = 0;
                game.correctCount = 0;
                game.wrongWords = [];
                game.timeLeft = 90;
                game.maxScore = 100;
                game.bullets = [];
                game.enemies = [];
                game.particles = [];
                game.running = true;
                game.questionAnswered = false;
                game.lastTime = performance.now();
                
                document.getElementById('levelDisplay').textContent = selectedLevel;
                
                showScreen('gameScreen');
                
                setTimeout(() => {
                    initGame();
                    nextQuestion();
                    updateUI();
                    showLoading(false);
                }, 100);
                
            } catch (error) {
                console.error('ê²Œì„ ì‹œì‘ ì˜¤ë¥˜:', error);
                game.words = shuffleArray([...defaultWords[selectedLevel]]);
                showLoading(false);
                
                game.questionIndex = 0;
                game.score = 0;
                game.correctCount = 0;
                game.wrongWords = [];
                game.timeLeft = 90;
                game.running = true;
                game.questionAnswered = false;
                game.lastTime = performance.now();
                
                showScreen('gameScreen');
                setTimeout(() => {
                    initGame();
                    nextQuestion();
                    updateUI();
                }, 100);
            }
        }

        function restartGame() {
            startGame();
        }

        // ========================================
        // Firebase ë‹¨ì–´ ë¡œë“œ
        // ========================================
        async function loadWordsFromFirebase(level) {
            return new Promise((resolve, reject) => {
                database.ref(`toeic_galaga/words/level${level}`).once('value')
                    .then(snapshot => {
                        const data = snapshot.val();
                        if (data) {
                            const words = Object.values(data);
                            resolve(words);
                        } else {
                            resolve([]);
                        }
                    })
                    .catch(reject);
            });
        }

        // ========================================
        // ê²Œì„ ì´ˆê¸°í™”
        // ========================================
        function initGame() {
            game.canvas = document.getElementById('gameCanvas');
            game.ctx = game.canvas.getContext('2d');
            
            resizeCanvas();
            createStars();
            setupInputs();
            
            window.addEventListener('resize', resizeCanvas);
            requestAnimationFrame(gameLoop);
        }

        function resizeCanvas() {
            const wrapper = document.getElementById('canvasWrapper');
            if (!wrapper) return;
            
            const rect = wrapper.getBoundingClientRect();
            game.width = rect.width;
            game.height = rect.height;
            game.canvas.width = game.width;
            game.canvas.height = game.height;
            game.ship.x = game.width / 2 - game.ship.width / 2;
            game.ship.y = game.height - game.ship.height - 20;
            createStars();
        }

        function createStars() {
            game.stars = [];
            for (let i = 0; i < 80; i++) {
                game.stars.push({
                    x: Math.random() * game.width,
                    y: Math.random() * game.height,
                    size: Math.random() * 2 + 0.5,
                    speed: Math.random() * 0.5 + 0.2,
                    alpha: Math.random()
                });
            }
        }

        function setupInputs() {
            document.addEventListener('keydown', (e) => {
                if (!game.running) return;
                if (e.code === 'ArrowLeft' || e.code === 'KeyA') game.keys.left = true;
                if (e.code === 'ArrowRight' || e.code === 'KeyD') game.keys.right = true;
                if (e.code === 'Space') { e.preventDefault(); shoot(); }
            });
            
            document.addEventListener('keyup', (e) => {
                if (e.code === 'ArrowLeft' || e.code === 'KeyA') game.keys.left = false;
                if (e.code === 'ArrowRight' || e.code === 'KeyD') game.keys.right = false;
            });

            const btnLeft = document.getElementById('btnLeft');
            const btnRight = document.getElementById('btnRight');
            const btnFire = document.getElementById('btnFire');

            btnLeft.addEventListener('touchstart', (e) => { e.preventDefault(); game.keys.left = true; });
            btnLeft.addEventListener('touchend', () => game.keys.left = false);
            btnRight.addEventListener('touchstart', (e) => { e.preventDefault(); game.keys.right = true; });
            btnRight.addEventListener('touchend', () => game.keys.right = false);
            btnFire.addEventListener('touchstart', (e) => { e.preventDefault(); shoot(); });

            btnLeft.addEventListener('mousedown', () => game.keys.left = true);
            btnLeft.addEventListener('mouseup', () => game.keys.left = false);
            btnLeft.addEventListener('mouseleave', () => game.keys.left = false);
            btnRight.addEventListener('mousedown', () => game.keys.right = true);
            btnRight.addEventListener('mouseup', () => game.keys.right = false);
            btnRight.addEventListener('mouseleave', () => game.keys.right = false);
            btnFire.addEventListener('click', shoot);

            game.canvas.addEventListener('mousemove', handlePointerMove);
            game.canvas.addEventListener('touchmove', handlePointerMove);
            game.canvas.addEventListener('click', shoot);
        }

        function handlePointerMove(e) {
            if (!game.running) return;
            e.preventDefault();
            const rect = game.canvas.getBoundingClientRect();
            const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
            game.ship.x = x - game.ship.width / 2;
            game.ship.x = Math.max(0, Math.min(game.width - game.ship.width, game.ship.x));
        }

        // ========================================
        // ë¬¸ì œ ìƒì„±
        // ========================================
        function nextQuestion() {
            if (game.questionIndex >= game.maxQuestions) {
                endGame();
                return;
            }
            
            game.currentWord = game.words[game.questionIndex % game.words.length];
            game.maxScore = 100;
            game.enemies = [];
            game.questionAnswered = false;
            
            spawnEnemies();
            game.questionIndex++;
            updateUI();
        }

        function spawnEnemies() {
            const correctWord = game.currentWord.word;
            
            // ì˜¤ë‹µ ë‹¨ì–´ ì„ íƒ
            const otherWords = game.words
                .filter(w => w.word !== correctWord)
                .map(w => w.word);
            const wrongWords = shuffleArray([...otherWords]).slice(0, 3);
            
            const allOptions = shuffleArray([
                { text: correctWord, isCorrect: true },
                ...wrongWords.map(w => ({ text: w, isCorrect: false }))
            ]);
            
            const spacing = game.width / 5;
            allOptions.forEach((option, i) => {
                game.enemies.push({
                    x: spacing * (i + 1) - 50,
                    y: -80 - i * 50,
                    width: 100,
                    height: 50,
                    speed: 0.8 + Math.random() * 0.3,
                    text: option.text,
                    isCorrect: option.isCorrect,
                    type: 'main',
                    color: '#3949ab',
                    glowColor: '#7986cb',
                    destroyed: false,
                    wobbleOffset: Math.random() * Math.PI * 2
                });
            });
        }

        // ========================================
        // ë°œì‚¬
        // ========================================
        function shoot() {
            if (!game.running || game.bullets.length >= 5) return;
            
            game.bullets.push({
                x: game.ship.x + game.ship.width / 2 - 3,
                y: game.ship.y,
                width: 6,
                height: 15,
                speed: 12
            });
            
            playSound(800, 0.1, 'square');
        }

        // ========================================
        // ê²Œì„ ë£¨í”„
        // ========================================
        function gameLoop(timestamp) {
            if (!game.canvas) return;
            
            const dt = (timestamp - game.lastTime) / 1000;
            game.lastTime = timestamp;
            
            update(dt);
            render();
            
            requestAnimationFrame(gameLoop);
        }

        function update(dt) {
            if (!game.running) return;
            
            game.timeLeft -= dt;
            if (game.timeLeft <= 0) {
                endGame();
                return;
            }
            
            if (game.keys.left) game.ship.x -= game.ship.speed;
            if (game.keys.right) game.ship.x += game.ship.speed;
            game.ship.x = Math.max(0, Math.min(game.width - game.ship.width, game.ship.x));
            
            game.bullets = game.bullets.filter(b => {
                b.y -= b.speed;
                return b.y > -b.height;
            });
            
            // ëª¨ë“  ë©”ì¸ ì ì´ í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°”ëŠ”ì§€ í™•ì¸
            let allMainEnemiesGone = true;
            let mainEnemyCount = 0;
            
            game.enemies.forEach(enemy => {
                if (enemy.destroyed) return;
                
                enemy.y += enemy.speed;
                enemy.x += Math.sin(enemy.y * 0.02 + enemy.wobbleOffset) * 1;
                
                if (enemy.type === 'main') {
                    mainEnemyCount++;
                    if (enemy.y < game.height + enemy.height) {
                        allMainEnemiesGone = false;
                    }
                }
                
                // ì¶©ëŒ ì²´í¬
                game.bullets.forEach((bullet, bi) => {
                    if (checkCollision(bullet, enemy)) {
                        game.bullets.splice(bi, 1);
                        enemy.destroyed = true;
                        
                        if (enemy.isCorrect) {
                            createExplosion(enemy.x + enemy.width/2, enemy.y + enemy.height/2, '#00ff88');
                            game.score += game.maxScore;
                            game.correctCount++;
                            game.questionAnswered = true;
                            playSound(523, 0.3, 'sine');
                            showFeedback('ì •ë‹µ! +' + game.maxScore + 'ì ', '#4caf50');
                            
                            setTimeout(() => nextQuestion(), 1000);
                        } else if (enemy.type === 'main') {
                            createExplosion(enemy.x + enemy.width/2, enemy.y + enemy.height/2, '#ff4444');
                            game.maxScore = Math.max(10, game.maxScore - 20);
                            playSound(200, 0.2, 'sawtooth');
                            showFeedback('ì˜¤ë‹µ! -20ì ', '#f44336');
                        }
                    }
                });
            });
            
            // ëª¨ë“  ë‹¨ì–´ê°€ í™”ë©´ ë°–ìœ¼ë¡œ ë‚˜ê°”ì„ ë•Œ (ì •ë‹µ ëª» ë§ì¶¤)
            if (mainEnemyCount > 0 && allMainEnemiesGone && !game.questionAnswered) {
                game.questionAnswered = true;
                game.wrongWords.push(game.currentWord);
                showFeedback('ì‹œê°„ ì´ˆê³¼! 0ì \nì •ë‹µ: ' + game.currentWord.word, '#ff9800');
                playSound(150, 0.3, 'sawtooth');
                
                setTimeout(() => nextQuestion(), 1500);
            }
            
            // íŒŒí‹°í´ ì—…ë°ì´íŠ¸
            game.particles = game.particles.filter(p => {
                p.x += p.vx;
                p.y += p.vy;
                p.vy += 0.15;
                p.life--;
                return p.life > 0;
            });
            
            // ë³„ ì—…ë°ì´íŠ¸
            game.stars.forEach(star => {
                star.y += star.speed;
                if (star.y > game.height) {
                    star.y = 0;
                    star.x = Math.random() * game.width;
                }
            });
            
            updateUI();
        }

        function checkCollision(a, b) {
            return a.x < b.x + b.width && a.x + a.width > b.x &&
                   a.y < b.y + b.height && a.y + a.height > b.y;
        }

        function createExplosion(x, y, color) {
            for (let i = 0; i < 15; i++) {
                game.particles.push({
                    x, y,
                    vx: (Math.random() - 0.5) * 8,
                    vy: (Math.random() - 0.5) * 8,
                    life: 30 + Math.random() * 20,
                    color,
                    size: 3 + Math.random() * 4
                });
            }
        }

        function showFeedback(text, color) {
            const feedback = document.getElementById('feedback');
            feedback.innerHTML = text.replace('\n', '<br>');
            feedback.style.color = '#fff';
            feedback.style.backgroundColor = color;
            feedback.style.boxShadow = `0 0 30px ${color}`;
            feedback.classList.add('show');
            setTimeout(() => feedback.classList.remove('show'), 1200);
        }

        // ========================================
        // ë Œë”ë§
        // ========================================
        function render() {
            const ctx = game.ctx;
            if (!ctx) return;
            
            ctx.fillStyle = '#0a0a15';
            ctx.fillRect(0, 0, game.width, game.height);
            
            // ë³„
            game.stars.forEach(star => {
                ctx.globalAlpha = 0.3 + Math.sin(performance.now() * 0.003 + star.x) * 0.4;
                ctx.fillStyle = '#fff';
                ctx.beginPath();
                ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
                ctx.fill();
            });
            ctx.globalAlpha = 1;
            
            if (!game.running) return;
            
            // íŒŒí‹°í´
            game.particles.forEach(p => {
                ctx.globalAlpha = p.life / 50;
                ctx.fillStyle = p.color;
                ctx.fillRect(p.x - p.size/2, p.y - p.size/2, p.size, p.size);
            });
            ctx.globalAlpha = 1;
            
            // ì 
            game.enemies.forEach(enemy => {
                if (enemy.destroyed) return;
                
                ctx.save();
                ctx.shadowColor = enemy.glowColor;
                ctx.shadowBlur = 15;
                ctx.fillStyle = enemy.color;
                
                // ë‘¥ê·¼ ì‚¬ê°í˜•
                const r = 10;
                ctx.beginPath();
                ctx.moveTo(enemy.x + r, enemy.y);
                ctx.lineTo(enemy.x + enemy.width - r, enemy.y);
                ctx.quadraticCurveTo(enemy.x + enemy.width, enemy.y, enemy.x + enemy.width, enemy.y + r);
                ctx.lineTo(enemy.x + enemy.width, enemy.y + enemy.height - r);
                ctx.quadraticCurveTo(enemy.x + enemy.width, enemy.y + enemy.height, enemy.x + enemy.width - r, enemy.y + enemy.height);
                ctx.lineTo(enemy.x + r, enemy.y + enemy.height);
                ctx.quadraticCurveTo(enemy.x, enemy.y + enemy.height, enemy.x, enemy.y + enemy.height - r);
                ctx.lineTo(enemy.x, enemy.y + r);
                ctx.quadraticCurveTo(enemy.x, enemy.y, enemy.x + r, enemy.y);
                ctx.closePath();
                ctx.fill();
                
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                ctx.shadowBlur = 0;
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 13px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(enemy.text, enemy.x + enemy.width/2, enemy.y + enemy.height/2);
                ctx.restore();
            });
            
            // ì´ì•Œ
            game.bullets.forEach(bullet => {
                ctx.save();
                ctx.shadowColor = '#00ffff';
                ctx.shadowBlur = 10;
                ctx.fillStyle = '#00ffff';
                ctx.fillRect(bullet.x, bullet.y, bullet.width, bullet.height);
                ctx.restore();
            });
            
            // ìš°ì£¼ì„ 
            drawShip();
        }

        function drawShip() {
            const ctx = game.ctx;
            const s = game.ship;
            const cx = s.x + s.width / 2;
            const cy = s.y + s.height / 2;
            
            ctx.save();
            ctx.translate(cx, cy);
            
            // ì—”ì§„ ë¶ˆê½ƒ
            ctx.shadowColor = '#ff6600';
            ctx.shadowBlur = 15;
            ctx.fillStyle = '#ff8800';
            ctx.beginPath();
            ctx.moveTo(-8, 15);
            ctx.lineTo(0, 28 + Math.sin(performance.now() * 0.02) * 4);
            ctx.lineTo(8, 15);
            ctx.closePath();
            ctx.fill();
            
            // ë³¸ì²´
            ctx.shadowColor = '#667eea';
            ctx.shadowBlur = 20;
            ctx.fillStyle = '#667eea';
            ctx.beginPath();
            ctx.moveTo(0, -18);
            ctx.lineTo(-16, 14);
            ctx.lineTo(-7, 16);
            ctx.lineTo(7, 16);
            ctx.lineTo(16, 14);
            ctx.closePath();
            ctx.fill();
            
            ctx.shadowBlur = 10;
            ctx.fillStyle = '#fff';
            ctx.beginPath();
            ctx.arc(0, -6, 4, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.restore();
        }

        function updateUI() {
            document.getElementById('score').textContent = game.score;
            document.getElementById('questionNum').textContent = `${Math.min(game.questionIndex, game.maxQuestions)}/${game.maxQuestions}`;
            document.getElementById('timeLeft').textContent = Math.max(0, Math.ceil(game.timeLeft));
            document.getElementById('targetMeaning').textContent = game.currentWord?.meaning || 'ì¤€ë¹„ì¤‘...';
            document.getElementById('dynamicScore').textContent = `${game.maxScore}ì `;
        }

        // ========================================
        // ê²Œì„ ì¢…ë£Œ
        // ========================================
        function endGame() {
            game.running = false;
            
            const wrongCount = game.maxQuestions - game.correctCount;
            
            // ê²°ê³¼ í‘œì‹œ
            document.getElementById('finalScore').textContent = game.score;
            document.getElementById('resultCorrect').textContent = game.correctCount;
            document.getElementById('resultWrong').textContent = wrongCount;
            document.getElementById('resultLevel').textContent = selectedLevel;
            
            // í‹€ë¦° ë‹¨ì–´ í‘œì‹œ
            const wrongSection = document.getElementById('wrongWordsSection');
            const wrongList = document.getElementById('wrongWordsList');
            
            if (game.wrongWords.length > 0) {
                wrongSection.style.display = 'block';
                wrongList.innerHTML = game.wrongWords.map(w => `
                    <div class="wrong-word-item">
                        <span class="word">${w.word}</span>
                        <span class="meaning">${w.meaning}</span>
                    </div>
                `).join('');
            } else {
                wrongSection.style.display = 'none';
            }
            
            // Firebaseì— ì ìˆ˜ ì €ì¥
            saveScore();
            
            showScreen('resultScreen');
        }

        // ========================================
        // ì ìˆ˜ ì €ì¥
        // ========================================
        function saveScore() {
            const scoreData = {
                studentId: currentUser.studentId,
                playerName: currentUser.playerName,
                score: game.score,
                level: selectedLevel,
                correct: game.correctCount,
                total: game.maxQuestions,
                timestamp: Date.now(),
                date: new Date().toISOString()
            };
            
            database.ref('toeic_galaga/scores').push(scoreData)
                .then(() => console.log('ì ìˆ˜ ì €ì¥ ì™„ë£Œ'))
                .catch(err => console.error('ì ìˆ˜ ì €ì¥ ì˜¤ë¥˜:', err));
        }

        // ========================================
        // ë¦¬ë”ë³´ë“œ
        // ========================================
        function showLeaderboard() {
            previousScreen = document.querySelector('.screen.active').id;
            loadLeaderboard();
            showScreen('leaderboardScreen');
        }

        function loadLeaderboard() {
            database.ref('toeic_galaga/scores')
                .orderByChild('score')
                .limitToLast(100)
                .once('value')
                .then(snapshot => {
                    allScores = [];
                    snapshot.forEach(child => {
                        allScores.push(child.val());
                    });
                    allScores.reverse(); // ë†’ì€ ì ìˆ˜ ìˆœ
                    filterLeaderboard('all');
                })
                .catch(err => {
                    console.error('ë¦¬ë”ë³´ë“œ ë¡œë“œ ì˜¤ë¥˜:', err);
                    document.getElementById('leaderboardTable').innerHTML = 
                        '<div style="text-align:center; padding:30px; color:#ff6b6b;">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</div>';
                });
        }

        function filterLeaderboard(level) {
            // íƒ­ í™œì„±í™”
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.level == level);
            });
            
            let filtered = allScores;
            if (level !== 'all') {
                filtered = allScores.filter(s => s.level == level);
            }
            
            renderLeaderboard(filtered);
        }

        function renderLeaderboard(scores) {
            const table = document.getElementById('leaderboardTable');
            
            if (scores.length === 0) {
                table.innerHTML = '<div style="text-align:center; padding:30px; opacity:0.6;">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];
            
            table.innerHTML = scores.slice(0, 50).map((s, i) => `
                <div class="lb-row">
                    <div class="lb-rank">${i < 3 ? medals[i] : (i + 1)}</div>
                    <div class="lb-name">${s.playerName}<br><small style="opacity:0.6">${s.studentId}</small></div>
                    <div class="lb-level">${s.level}ì </div>
                    <div class="lb-score">${s.score}</div>
                </div>
            `).join('');
        }

        function goBack() {
            showScreen(previousScreen);
        }

        // ========================================
        // ê´€ë¦¬ì - CSV ì—…ë¡œë“œ
        // ========================================
        function handleCSV(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                parseCSV(text);
            };
            reader.readAsText(file);
        }

        function parseCSV(text) {
            const lines = text.split('\n').filter(line => line.trim());
            csvData = [];
            
            // ì²« ì¤„ì´ í—¤ë”ì¸ì§€ í™•ì¸
            const firstLine = lines[0].toLowerCase();
            const startIndex = (firstLine.includes('word') || firstLine.includes('meaning')) ? 1 : 0;
            
            for (let i = startIndex; i < lines.length; i++) {
                const parts = lines[i].split(',').map(p => p.trim());
                if (parts.length >= 2 && parts[0] && parts[1]) {
                    csvData.push({
                        word: parts[0],
                        meaning: parts[1]
                    });
                }
            }
            
            // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
            const preview = document.getElementById('csvPreview');
            if (csvData.length > 0) {
                preview.style.display = 'block';
                preview.innerHTML = `<strong>ì´ ${csvData.length}ê°œ ë‹¨ì–´</strong><br><br>` +
                    csvData.slice(0, 10).map(w => `${w.word} â†’ ${w.meaning}`).join('<br>') +
                    (csvData.length > 10 ? '<br>...' : '');
                document.getElementById('uploadBtn').disabled = false;
            } else {
                preview.style.display = 'block';
                preview.innerHTML = '<span style="color:#ff6b6b;">ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</span>';
                document.getElementById('uploadBtn').disabled = true;
            }
        }

        function uploadWords() {
            if (csvData.length === 0) return;
            
            const level = document.getElementById('adminLevelSelect').value;
            
            if (!confirm(`ë ˆë²¨ ${level}ì— ${csvData.length}ê°œ ë‹¨ì–´ë¥¼ ì—…ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ê¸°ì¡´ ë‹¨ì–´ê°€ ëª¨ë‘ ëŒ€ì²´ë©ë‹ˆë‹¤)`)) {
                return;
            }
            
            showLoading(true);
            
            // ê¸°ì¡´ ë°ì´í„° ì‚­ì œ í›„ ìƒˆë¡œ ì—…ë¡œë“œ
            const updates = {};
            csvData.forEach((word, index) => {
                updates[`word_${index}`] = word;
            });
            
            database.ref(`toeic_galaga/words/level${level}`).set(updates)
                .then(() => {
                    showLoading(false);
                    alert(`${csvData.length}ê°œ ë‹¨ì–´ê°€ ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!`);
                    csvData = [];
                    document.getElementById('csvPreview').style.display = 'none';
                    document.getElementById('csvFile').value = '';
                    document.getElementById('uploadBtn').disabled = true;
                    loadWordCounts();
                })
                .catch(err => {
                    showLoading(false);
                    alert('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + err.message);
                });
        }

        function loadWordCounts() {
            const levels = [300, 400, 500, 600, 700, 800, 900, 1000];
            const container = document.getElementById('wordCountDisplay');
            container.innerHTML = '';
            
            levels.forEach(level => {
                database.ref(`toeic_galaga/words/level${level}`).once('value')
                    .then(snapshot => {
                        const count = snapshot.exists() ? Object.keys(snapshot.val()).length : 0;
                        container.innerHTML += `
                            <div class="word-count-item">
                                <div class="count">${count}</div>
                                <div class="level">${level}ì </div>
                            </div>
                        `;
                    });
            });
        }

        // ========================================
        // ì‚¬ìš´ë“œ
        // ========================================
        function playSound(freq, duration, type) {
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.frequency.value = freq;
                osc.type = type;
                gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
                osc.start(audioCtx.currentTime);
                osc.stop(audioCtx.currentTime + duration);
            } catch (e) {}
        }

        // ========================================
        // ìœ í‹¸ë¦¬í‹°
        // ========================================
        function shuffleArray(arr) {
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            return arr;
        }
    </script>
</body>
</html>
